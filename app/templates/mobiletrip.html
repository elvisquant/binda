<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Trip Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

<!-- Main application wrapper -->
<div class="flex h-screen">

    <!-- Sidebar (Left) - Modified for responsiveness -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg 
                             transform -translate-x-full transition-transform duration-300 ease-in-out 
                             md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700 
                             flex flex-col flex-shrink-0">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
          <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
        </div>
        <!-- Close button for mobile sidebar -->
        <button id="sidebar-close-button" class="md:hidden text-gray-700 dark:text-gray-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard">Dashboard</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics">Analytics</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="users" class="w-5 h-5"></i><a href="users">User</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="user" class="w-5 h-5"></i><a href="driver">Driver</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="panne">Pannes (Issues)</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="car" class="w-5 h-5"></i><a href="vehicle">Vehicles</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="wrench" class="w-5 h-5"></i><a href="reparation">Reparation</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="droplet" class="w-5 h-5"></i><a href="fuel">Fuel</a>
            </li>
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="settings" class="w-5 h-5"></i><a href="maintenance">Maintenance</a>
            </li>
            <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="route" class="w-5 h-5"></i><a href="trip">Trip</a>
            </li>
        </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>

    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- Content Area Wrapper (Header + Main Content + Right Sidebar) -->
    <div class="flex-1 flex flex-col overflow-hidden">
      
      <!-- Header (Mobile Hamburger, Desktop Title, Theme Toggle, User Info) -->
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
          <!-- Hamburger Menu Button - visible only on mobile -->
          <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2">
              <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          
          <!-- Mobile Title - visible only on mobile -->
          <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">
              FleetDash
          </div>

          <!-- Desktop Title/Context - hidden on mobile -->
          <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200">
              Trip Management
          </div>
          
          <!-- Right side of header: Theme Toggle & User Info -->
          <div class="flex items-center space-x-3">
              <button id="theme-toggle-header" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                  <!-- Icon will be set by JS -->
              </button>
              <!-- User info for desktop header - hidden on mobile -->
              <div class="hidden md:flex items-center space-x-2">
                  <div class="text-sm font-semibold" id="userDisplayNameHeader">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Admin</div>
              </div>
          </div>
      </header>

      <!-- Main scrollable content area (Main Page Content + Right Sidebar) -->
      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Trip Table Section -->
          <section id="trip-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
              <div class="flex flex-wrap gap-2 items-center">
                <button onclick="openAddTripModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
                  <i data-lucide="plus" class="w-4 h-4"></i> Add Trip
                </button>
                <input type="text" id="tripSearch" placeholder="Search trips (location, purpose, ID...)" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <button onclick="exportTripsExcel()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
                <button onclick="exportTripsPDF()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
              </div>
            </div>

            <div class="mb-4 flex flex-wrap items-center gap-2">
              <span class="text-sm font-medium mr-2">Filter Trips by Start Date:</span>
              <button id="trip-filter-today" onclick="applyTripDateFilter('today')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
              <button id="trip-filter-last7" onclick="applyTripDateFilter('last7days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
              <button id="trip-filter-last30" onclick="applyTripDateFilter('last30days')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
              <button id="trip-filter-all" onclick="applyTripDateFilter('all')" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
              <button id="trip-filter-custom-btn" onclick="toggleTripCustomDateRange()" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom Range</button>
            </div>
            <div id="tripCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
              <input type="date" id="tripCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <span class="text-sm">to</span>
              <input type="date" id="tripCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <button onclick="applyTripCustomDateFilter()" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
            </div>

            <div class="overflow-x-auto">
              <table id="tripsTable" class="w-full text-left text-sm">
                <thead>
                  <tr class="border-b dark:border-gray-700">
                    <th class="py-3 px-2 font-semibold">ID</th>
                    <th class="px-2 font-semibold">Vehicle</th>
                    <th class="px-2 font-semibold">Driver</th>
                    <th class="px-2 font-semibold">Start Location</th>
                    <th class="px-2 font-semibold">End Location</th>
                    <th class="px-2 font-semibold">Start Time</th>
                    <th class="px-2 font-semibold">Status</th>
                    <th class="px-2 font-semibold text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="tripsBody"></tbody>
              </table>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div class="text-sm text-gray-600 dark:text-gray-400" id="tripsCount"></div>
              <div class="flex items-center space-x-1" id="tripsPagination"></div>
            </div>
          </section>
        </main>

        <!-- Right Sidebar -->
        <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden lg:block flex-shrink-0 overflow-y-auto border-l dark:border-gray-700">
            <div class="flex justify-end items-center"> <!-- Changed: Removed theme toggle, aligned user info to right -->
              <div>
                  <div class="text-sm font-semibold text-right" id="userDisplayNameRightSidebar">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 text-right">Admin</div>
              </div>
            </div>
            <div><h4 class="font-bold mb-4 text-lg">Recent Updates</h4><div class="flex flex-col space-y-6 relative"><div class="absolute left-5 top-0 bottom-0 w-0.5 bg-blue-500"></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">New trip planned</p><p class="text-sm text-gray-500 dark:text-gray-400">30 minutes ago</p></div></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">Trip completed</p><p class="text-sm text-gray-500 dark:text-gray-400">1 hour ago</p></div></div></div></div>
            <div class="mt-8"><h4 class="font-bold mb-4 text-lg">Quick Actions</h4><div class="grid grid-cols-2 gap-2"><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="map" class="w-5 h-5 mb-1"></i><span class="text-xs">View Routes</span></button><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="plus-square" class="w-5 h-5 mb-1"></i><span class="text-xs">New Trip</span></button></div></div>
        </aside>
      </div>
    </div>
</div>

<!-- Add/Edit Trip Modal -->
<div id="addTripModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="tripModalTitle">Add New Trip</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the trip details below</p>
        </div>
        <button onclick="closeAddTripModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addTripForm" class="space-y-4">
        <input type="hidden" id="tripId_form">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="trip_vehicle_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle</label>
              <select id="trip_vehicle_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
            </div>
            <div>
              <label for="trip_driver_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Driver</label>
              <select id="trip_driver_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
            </div>
        </div>
         <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="trip_start_location_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Location</label>
              <input type="text" id="trip_start_location_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., Main Office">
            </div>
            <div>
              <label for="trip_end_location_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Location</label>
              <input type="text" id="trip_end_location_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., Client Site A">
            </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="trip_start_time_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start Time</label>
              <input type="datetime-local" id="trip_start_time_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
            <div>
              <label for="trip_end_time_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">End Time (Optional)</label>
              <input type="datetime-local" id="trip_end_time_form" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white">
            </div>
        </div>
        <div>
            <label for="trip_purpose_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Purpose</label>
            <input type="text" id="trip_purpose_form" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., Delivery, Client Meeting">
        </div>
        <div>
            <label for="trip_status_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
            <select id="trip_status_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white"></select>
        </div>
        <div>
            <label for="trip_notes_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Notes (Optional)</label>
            <textarea id="trip_notes_form" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Any additional details about the trip..."></textarea>
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddTripModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="tripSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Trip
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Trip Record Modal -->
<div id="viewTripModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Trip Details</h3>
        <button onclick="closeViewTripModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewTripDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
            <div><span class="view-detail-label">Trip ID:</span> <span id="view-trip-id" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Vehicle:</span> <span id="view-trip-vehicle" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Driver:</span> <span id="view-trip-driver" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Start Location:</span> <span id="view-trip-start_location" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">End Location:</span> <span id="view-trip-end_location" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Start Time:</span> <span id="view-trip-start_time" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">End Time:</span> <span id="view-trip-end_time" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Purpose:</span> <span id="view-trip-purpose" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Status:</span> <span id="view-trip-status" class="view-detail-value"></span></div>
            <div class="md:col-span-2"><span class="view-detail-label">Notes:</span> <p id="view-trip-notes" class="view-detail-value whitespace-pre-wrap mt-1"></p></div>
            <div><span class="view-detail-label">Created At:</span> <span id="view-trip-created_at" class="view-detail-value"></span></div>
        </div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" onclick="closeViewTripModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal (reused) -->
<div id="genericConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirm Action</h3>
        <button onclick="closeGenericConfirmModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to proceed?</p>
      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeGenericConfirmModal()"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
          Cancel
        </button>
        <button id="genericConfirmModalConfirmBtn"
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Information/Status Modal (reused) -->
<div id="infoStatusModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
      </div>
      <h3 id="infoStatusModalTitle" class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-2">Status</h3>
      <div class="mt-2">
        <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message here.</p>
      </div>
      <div class="mt-5 sm:mt-6">
        <button type="button"
                onclick="closeInfoStatusModal()"
                id="infoStatusModalOkButton"
                class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
          OK
        </button>
      </div>
    </div>
  </div>
</div>


<script>
  const API_BASE_URL = 'http://34.201.67.218:8000';
  const LOGIN_PAGE_URL = 'login.html';

  // --- Authentication Helper ---
  function getAuthToken() { return localStorage.getItem('accessToken'); }
  function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("JWT Parse Error:", e); return null; }}

  function updateUserInfoDisplay() {
    const token = getAuthToken();
    const userDisplayElements = [
        document.getElementById('userDisplayNameHeader'),
        document.getElementById('userDisplayNameRightSidebar')
    ];

    userDisplayElements.forEach(userDisplayElement => {
        if (!userDisplayElement) return;
        if (token) {
            const decoded = parseJwt(token);
            userDisplayElement.textContent = (decoded && decoded.sub) ? decoded.sub : 'User (Authenticated)';
        } else {
            userDisplayElement.textContent = 'Guest';
        }
    });
  }

  async function apiRequest(endpoint, method = 'GET', body = null) {
    const token = getAuthToken();
    const headers = { 'Content-Type': 'application/json' };
    const publicEndpoints = []; 
    const isPublic = publicEndpoints.some(publicEp => endpoint.startsWith(publicEp));

    if (token && !isPublic) headers['Authorization'] = `Bearer ${token}`;
    else if (!token && !isPublic) console.warn(`WARN: Protected endpoint ${endpoint} called without token.`);

    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      const responseForJson = response.clone();
      const responseForText = response.clone();

      if (response.status === 401 && !isPublic) {
        openInfoStatusModal("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 3000);
        return null;
      }
      if (response.status === 204) return true; 

      const responseData = await responseForJson.json().catch(async (jsonError) => {
          const text = await responseForText.text();
          console.error(`JSON Parse Error for ${endpoint}. Status: ${response.status}. Response text (first 100 chars): ${text.substring(0,100)}...`, jsonError);
          if (!response.ok) {
              return Promise.reject({ detail: text || `Server error ${response.status}` });
          }
          throw new Error(`Invalid JSON response from server (status ${response.status}). Check console for raw response.`);
      });

      if (!response.ok) {
        const errorDetail = responseData.detail || (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData) || 'Unknown error from server.';
        console.error(`API Error for ${endpoint}: ${response.status}`, errorDetail);
        openInfoStatusModal(`API Error: ${response.status}`, errorDetail, "error");
        return null;
      }
      return responseData;
    } catch (error) {
      console.error(`Network/Catch Error during API request to ${endpoint}:`, error);
      openInfoStatusModal("Request Error", error.message || "A network error occurred. Please try again.", "error");
      return null;
    }
  }

  // --- Global Variables for Trips ---
  let allFetchedTripsFromServer = [];
  let vehicleDataForDropdown = []; 
  let driverDataForDropdown = [];   
  const mockTripStatuses = ["planned", "ongoing", "completed", "cancelled", "delayed"]; 

  const tripsPerPage = 5;
  let currentTripPage = 1;
  let tripToEditId = null;
  let tripToDeleteId = null;
  let activeTripDateFilter = 'all';
  let customTripFilterStartDate = null;
  let customTripFilterEndDate = null;

  let currentConfirmAction = null;
  let currentActionData = null;
  let infoStatusModalTimeout = null;

  // --- Sidebar Toggle Functionality ---
  const sidebar = document.getElementById('sidebar');
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const sidebarCloseButton = document.getElementById('sidebar-close-button');
  const sidebarOverlay = document.getElementById('sidebar-overlay');

  function openMobileMenu() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        sidebarOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden', 'md:overflow-auto');
    }
  }

  function closeMobileMenu() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }
  }
  
  // --- Theme Toggle ---
  const themeToggleButton = document.getElementById('theme-toggle-header');
  function setInitialThemeIcon() {
    if (themeToggleButton) {
        if (document.documentElement.classList.contains('dark')) {
            themeToggleButton.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
        } else {
            themeToggleButton.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
        }
        lucide.createIcons();
    }
  }

  function setActiveTripDateFilterButton(filterId) {
    document.querySelectorAll('#trip-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(filterId.startsWith('trip-filter-') ? filterId : `trip-filter-${filterId}`);
    if (activeBtn) activeBtn.classList.add('active');
  }

  // --- DOMContentLoaded ---
  document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      updateUserInfoDisplay();
      
      themeToggleButton?.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        setInitialThemeIcon(); 
      });
      setInitialThemeIcon();

      mobileMenuButton?.addEventListener('click', openMobileMenu);
      sidebarCloseButton?.addEventListener('click', closeMobileMenu);
      sidebarOverlay?.addEventListener('click', closeMobileMenu);
       document.querySelectorAll('#sidebar nav a').forEach(link => {
          link.addEventListener('click', () => {
              if (window.innerWidth < 768) { // md breakpoint
                  closeMobileMenu();
              }
          });
      });

      document.getElementById('addTripModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddTripModal(); });
      document.getElementById('viewTripModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeViewTripModal(); });
      document.getElementById('genericConfirmModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeGenericConfirmModal(); });
      document.getElementById('genericConfirmModalConfirmBtn').addEventListener('click', async () => {
        if (typeof currentConfirmAction === 'function') {
            await currentConfirmAction(currentActionData);
        }
        closeGenericConfirmModal();
      });
      document.getElementById('infoStatusModal').addEventListener('click', e => { if (e.target === e.currentTarget || e.target.id === 'infoStatusModalOkButton' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });

      document.getElementById('global-logout-btn')?.addEventListener('click', (e) => {
          e.preventDefault();
          localStorage.removeItem('accessToken');
          openInfoStatusModal("Logged Out", "You have been successfully logged out.", "success", 2500);
          updateUserInfoDisplay();
          allFetchedTripsFromServer = [];
          renderTripsTable();
          // setTimeout(() => { window.location.href = LOGIN_PAGE_URL; }, 2500);
      });
      await initializeTripSection();
  });

  function getISODateString(date) { return new Date(date).toISOString().split('T')[0]; }
  function getDateRangeForFilter(filterType) { 
    const today=new Date(); today.setHours(0,0,0,0); let sD=new Date(today); let eD=new Date(today); eD.setHours(23,59,59,999);
    switch(filterType){ case 'today':break; case 'last7days':sD.setDate(today.getDate()-6);break; case 'last30days':sD.setDate(today.getDate()-29);break; case 'all':return{startDate:null,endDate:null}; default:return{startDate:null,endDate:null};}
    return{startDate:getISODateString(sD),endDate:getISODateString(eD)};
  }

  async function initializeTripSection() {
    await fetchDropdownDataForTrips(); 
    const token = getAuthToken();
    if (!token) {
        document.getElementById('tripsBody').innerHTML = `<tr><td colspan="8" class="text-center py-8 text-red-500">Please log in to view trips.</td></tr>`;
        document.getElementById('tripsCount').textContent = '0 records';
        document.getElementById('tripsPagination').innerHTML = '';
    } else {
        await fetchTrips();
    }
    document.getElementById('tripSearch').addEventListener('input', () => { currentTripPage = 1; fetchTrips(); });
    document.getElementById('addTripForm').addEventListener('submit', handleTripFormSubmit);
    setActiveTripDateFilterButton('all');
  }

  async function fetchDropdownDataForTrips() {
    vehicleDataForDropdown = await apiRequest('/vehicle/?limit=1000') || []; 
    driverDataForDropdown = await apiRequest('/driver/?limit=1000') || [];   
    populateTripFormDropdowns();
  }

  function populateSelectWithOptionsGeneric(selectElementId, optionsArray, valueField, textField, placeholder = "Select Option", displayFormatter = null) {
    const selectElement = document.getElementById(selectElementId);
    if (!selectElement) { console.error(`Populate: Element '${selectElementId}' not found.`); return; }

    const currentValue = selectElement.value; 
    selectElement.innerHTML = `<option value="">${placeholder}</option>`;
    selectElement.disabled = !Array.isArray(optionsArray) || optionsArray.length === 0;

    if (Array.isArray(optionsArray)) {
        optionsArray.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt[valueField];
            option.textContent = displayFormatter ? displayFormatter(opt) : (opt[textField] !== undefined ? opt[textField] : `(ID: ${opt[valueField]})`);
            selectElement.appendChild(option);
        });
        if (optionsArray.some(opt => String(opt[valueField]) === String(currentValue))) {
            selectElement.value = currentValue;
        }
    }
  }

  function populateTripFormDropdowns() {
    populateSelectWithOptionsGeneric('trip_vehicle_id_form', vehicleDataForDropdown, 'id', 'plate_number', "Select Vehicle", (v) => `${v.plate_number} (${v.make_name || v.make} ${v.model_name || v.model})`); 
    populateSelectWithOptionsGeneric('trip_driver_id_form', driverDataForDropdown, 'id', 'full_name', "Select Driver", (d) => `${d.first_name} ${d.last_name} (ID: ${d.id})`); 

    const statusSelect = document.getElementById('trip_status_form');
    statusSelect.innerHTML = '<option value="">Select Status</option>';
    mockTripStatuses.forEach(s => {
        const o=document.createElement('option'); o.value=s;
        o.textContent=s.charAt(0).toUpperCase() + s.slice(1).replace(/_/g, ' '); statusSelect.appendChild(o);
    });
  }

  async function fetchTrips() {
    const searchTerm = document.getElementById('tripSearch').value;
    const data = await apiRequest(`/trip/?limit=${tripsPerPage}&skip=${(currentTripPage - 1) * tripsPerPage}&search=${encodeURIComponent(searchTerm)}`);
    if (data) { allFetchedTripsFromServer = data;} else { allFetchedTripsFromServer = []; }
    renderTripsTable();
  }

  function formatDateTimeForDisplay(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    try {
        return new Date(dateTimeString).toLocaleString();
    } catch (e) {
        return dateTimeString; 
    }
  }

  function renderTripsTable() {
    let recordsToDisplay = [...allFetchedTripsFromServer];
    if (activeTripDateFilter !== 'all') {
      let range = (activeTripDateFilter === 'custom' && customTripFilterStartDate && customTripFilterEndDate) ?
                  { startDate: customTripFilterStartDate, endDate: customTripFilterEndDate } :
                  getDateRangeForFilter(activeTripDateFilter);
      if (range.startDate && range.endDate) {
        recordsToDisplay = recordsToDisplay.filter(r => {
          if (!r.start_time) return false; 
          const recordStartDate = getISODateString(new Date(r.start_time));
          return recordStartDate >= range.startDate && recordStartDate <= range.endDate;
        });
      }
    }
    const searchTermClient = document.getElementById('tripSearch').value.toLowerCase();
    if (searchTermClient && recordsToDisplay.length > 0) {
        recordsToDisplay = recordsToDisplay.filter(r =>
            (r.id && r.id.toString().includes(searchTermClient)) ||
            (r.start_location && r.start_location.toLowerCase().includes(searchTermClient)) ||
            (r.end_location && r.end_location.toLowerCase().includes(searchTermClient)) ||
            (r.purpose && r.purpose.toLowerCase().includes(searchTermClient)) ||
            (r.status && r.status.toLowerCase().includes(searchTermClient)) ||
            (vehicleDataForDropdown.find(v => v.id === r.vehicle_id)?.plate_number.toLowerCase().includes(searchTermClient)) ||
            (driverDataForDropdown.find(d => d.id === r.driver_id)?.first_name.toLowerCase().includes(searchTermClient)) ||
            (driverDataForDropdown.find(d => d.id === r.driver_id)?.last_name.toLowerCase().includes(searchTermClient))
        );
    }

    const tripsBody = document.getElementById('tripsBody');
    if (recordsToDisplay.length > 0) {
        tripsBody.innerHTML = recordsToDisplay.map(r => {
        const vehicle = vehicleDataForDropdown.find(v => v.id === r.vehicle_id);
        const driver = driverDataForDropdown.find(d => d.id === r.driver_id);
        const vehicleDisplay = vehicle ? `${vehicle.plate_number}` : `VehicleID ${r.vehicle_id}`;
        const driverDisplay = driver ? `${driver.first_name} ${driver.last_name}` : `DriverID ${r.driver_id}`;
        const statusFormatted = r.status ? (r.status.charAt(0).toUpperCase() + r.status.slice(1).replace(/_/g, ' ')) : 'N/A';
        const statusColor = r.status === "completed" ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" :
                            r.status === "ongoing" ? "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200" :
                            r.status === "planned" ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" :
                            r.status === "cancelled" ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" :
                            "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200";

        return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${r.id}">
                    <td class="py-3 px-2">${r.id}</td>
                    <td class="px-2">${vehicleDisplay}</td>
                    <td class="px-2">${driverDisplay}</td>
                    <td class="px-2">${r.start_location || 'N/A'}</td>
                    <td class="px-2">${r.end_location || 'N/A'}</td>
                    <td class="px-2">${formatDateTimeForDisplay(r.start_time)}</td>
                    <td class="px-2"><span class="px-2 py-1 text-xs rounded-full ${statusColor}">${statusFormatted}</span></td>
                    <td class="px-2 text-center whitespace-nowrap">
                    <button onclick="openViewTripModal(${r.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                    <button onclick="openEditTripModal(${r.id})" class="text-blue-600 dark:text-blue-400 p-1 ml-1" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="openConfirmDeleteTripModal(${r.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td></tr>`;
        }).join('');
    } else {
        let message = "No trip records found.";
        if (!getAuthToken()) { message = "Please log in to view trip records."; }
        else if (getAuthToken() && allFetchedTripsFromServer.length === 0 && !searchTermClient ) { message = "No trips in the system yet. Try adding one!";}
        else if (searchTermClient) { message = "No trips match your current search/filter criteria." }
        tripsBody.innerHTML = `<tr><td colspan="8" class="text-center py-8 text-gray-500">${message}</td></tr>`; 
    }
    lucide.createIcons();
    const displayedRecordCount = recordsToDisplay.length;
    const estimatedStart = displayedRecordCount > 0 ? (currentTripPage -1) * tripsPerPage + 1 : 0;
    const estimatedEnd = (currentTripPage -1) * tripsPerPage + displayedRecordCount;
    document.getElementById('tripsCount').textContent = `Showing ${estimatedStart} to ${estimatedEnd} of approx. ${estimatedEnd} records (current view)`;
    renderTripPagination(allFetchedTripsFromServer.length); 
  }

  function renderTripPagination(currentPageRecordCount) { 
    const paginationContainer = document.getElementById('tripsPagination');
    paginationContainer.innerHTML = '';
    if (currentTripPage === 1 && currentPageRecordCount < tripsPerPage) {
        if (currentPageRecordCount === 0) {} 
        else if (currentPageRecordCount < tripsPerPage && currentTripPage === 1) return; 
    }

    const buttonClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";
    const inactiveClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";
    const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";

    const prevButton = document.createElement('button');
    prevButton.innerHTML = `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`;
    prevButton.className = `${buttonClasses} ${currentTripPage === 1 ? disabledClasses : inactiveClasses}`;
    if (currentTripPage > 1) {
        prevButton.onclick = () => { currentTripPage--; fetchTrips(); };
    } else { prevButton.disabled = true; }
    paginationContainer.appendChild(prevButton);

    const pageInfo = document.createElement('span');
    pageInfo.className = "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400";
    pageInfo.textContent = `Page ${currentTripPage}`;
    paginationContainer.appendChild(pageInfo);

    const nextButton = document.createElement('button');
    nextButton.innerHTML = `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`;
    const hasMore = currentPageRecordCount === tripsPerPage; 
    nextButton.className = `${buttonClasses} ${!hasMore ? disabledClasses : inactiveClasses}`;
    if (hasMore) {
        nextButton.onclick = () => { currentTripPage++; fetchTrips(); };
    } else { nextButton.disabled = true; }
    paginationContainer.appendChild(nextButton);
    lucide.createIcons();
  }

  async function openAddTripModal() {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to add a trip.", "error"); return; }
    tripToEditId = null;
    document.getElementById('addTripForm').reset();
    await fetchDropdownDataForTrips(); 
    document.getElementById('tripModalTitle').textContent = "Add New Trip";
    document.getElementById('tripSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> Add Trip`;
    lucide.createIcons();
    document.getElementById('addTripModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function formatDateTimeForInput(dateTimeString) {
    if (!dateTimeString) return '';
    const date = new Date(dateTimeString);
    if (isNaN(date.getTime())) return '';
    const year = date.getFullYear();
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const day = date.getDate().toString().padStart(2, '0');
    const hours = date.getHours().toString().padStart(2, '0');
    const minutes = date.getMinutes().toString().padStart(2, '0');
    return `${year}-${month}-${day}T${hours}:${minutes}`;
  }

  async function openEditTripModal(id) {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to edit a trip.", "error"); return; }
    const recordToEdit = await apiRequest(`/trip/${id}`);
    if (!recordToEdit) { openInfoStatusModal("Error","Could not fetch trip details for editing.", "error"); return; }

    tripToEditId = id;
    document.getElementById('addTripForm').reset();
    await fetchDropdownDataForTrips(); 

    document.getElementById('tripModalTitle').textContent = "Edit Trip Record";
    document.getElementById('tripSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save Changes`;

    document.getElementById('tripId_form').value = recordToEdit.id;
    document.getElementById('trip_vehicle_id_form').value = recordToEdit.vehicle_id;
    document.getElementById('trip_driver_id_form').value = recordToEdit.driver_id;
    document.getElementById('trip_start_location_form').value = recordToEdit.start_location || '';
    document.getElementById('trip_end_location_form').value = recordToEdit.end_location || '';
    document.getElementById('trip_start_time_form').value = formatDateTimeForInput(recordToEdit.start_time);
    document.getElementById('trip_end_time_form').value = formatDateTimeForInput(recordToEdit.end_time);
    document.getElementById('trip_purpose_form').value = recordToEdit.purpose || '';
    document.getElementById('trip_status_form').value = recordToEdit.status || '';
    document.getElementById('trip_notes_form').value = recordToEdit.notes || '';

    lucide.createIcons();
    document.getElementById('addTripModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeAddTripModal() {
    document.getElementById('addTripModal').classList.add('hidden');
    document.body.style.overflow = '';
    tripToEditId = null;
    document.getElementById('addTripForm').reset();
  }

  async function openViewTripModal(id) {
    const record = await apiRequest(`/trip/${id}`);
    if (!record) { openInfoStatusModal("Error", "Could not fetch trip details for viewing.", "error"); return; }

    const vehicle = vehicleDataForDropdown.find(v => v.id === record.vehicle_id);
    const driver = driverDataForDropdown.find(d => d.id === record.driver_id);

    document.getElementById('view-trip-id').textContent = record.id;
    document.getElementById('view-trip-vehicle').textContent = vehicle ? `${vehicle.plate_number} (${vehicle.make_name || vehicle.make} ${vehicle.model_name || vehicle.model})` : `VehicleID ${record.vehicle_id}`;
    document.getElementById('view-trip-driver').textContent = driver ? `${driver.first_name} ${driver.last_name}` : `DriverID ${record.driver_id}`;
    document.getElementById('view-trip-start_location').textContent = record.start_location || 'N/A';
    document.getElementById('view-trip-end_location').textContent = record.end_location || 'N/A';
    document.getElementById('view-trip-start_time').textContent = formatDateTimeForDisplay(record.start_time);
    document.getElementById('view-trip-end_time').textContent = formatDateTimeForDisplay(record.end_time);
    document.getElementById('view-trip-purpose').textContent = record.purpose || 'N/A';
    document.getElementById('view-trip-status').textContent = record.status ? (record.status.charAt(0).toUpperCase() + record.status.slice(1).replace(/_/g, ' ')) : 'N/A';
    document.getElementById('view-trip-notes').textContent = record.notes || 'No notes provided.';
    document.getElementById('view-trip-created_at').textContent = formatDateTimeForDisplay(record.created_at || record.registration_date); 

    document.getElementById('viewTripModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    lucide.createIcons();
  }
  function closeViewTripModal() { document.getElementById('viewTripModal').classList.add('hidden'); document.body.style.overflow = ''; }


  function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIcon, onConfirmCallback, actionData = null) {
    document.getElementById('genericConfirmModalTitle').textContent = title;
    document.getElementById('genericConfirmModalMessage').textContent = message;
    const confirmBtn = document.getElementById('genericConfirmModalConfirmBtn');
    confirmBtn.innerHTML = `<i data-lucide="${confirmButtonIcon || 'check-circle'}" class="w-4 h-4"></i> ${confirmButtonText || 'Confirm'}`;
    if(confirmButtonIcon === 'trash-2'){ confirmBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600'); confirmBtn.classList.add('bg-red-500', 'hover:bg-red-600');}
    else { confirmBtn.classList.remove('bg-red-500', 'hover:bg-red-600'); confirmBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');}
    lucide.createIcons();
    currentConfirmAction = onConfirmCallback; currentActionData = actionData;
    document.getElementById('genericConfirmModal').classList.remove('hidden'); document.body.style.overflow = 'hidden';
  }
  function closeGenericConfirmModal() {
    document.getElementById('genericConfirmModal').classList.add('hidden'); document.body.style.overflow = '';
    currentConfirmAction = null; currentActionData = null;
  }
  function openInfoStatusModal(title, message, type = 'success', autoCloseDelay = 3000) {
    const modal = document.getElementById('infoStatusModal');
    const titleEl = document.getElementById('infoStatusModalTitle');
    const messageEl = document.getElementById('infoStatusModalMessage');
    const iconContainer = document.getElementById('infoStatusModalIconContainer');
    const okButton = document.getElementById('infoStatusModalOkButton');
    titleEl.textContent = title; messageEl.textContent = message;
    if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout);
    iconContainer.innerHTML = '';
    if (type === 'success') { iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4'; iconContainer.innerHTML = `<i data-lucide="check" class="h-6 w-6 text-green-600"></i>`; okButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:text-sm';}
    else if (type === 'error') { iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4'; iconContainer.innerHTML = `<i data-lucide="x-circle" class="h-6 w-6 text-red-600"></i>`; okButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm';}
    else { iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4'; iconContainer.innerHTML = `<i data-lucide="info" class="h-6 w-6 text-blue-600"></i>`; okButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm';}
    lucide.createIcons();
    modal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
    if (autoCloseDelay > 0) { infoStatusModalTimeout = setTimeout(() => { closeInfoStatusModal(); }, autoCloseDelay); }
  }
  function closeInfoStatusModal() {
    if (infoStatusModalTimeout) { clearTimeout(infoStatusModalTimeout); infoStatusModalTimeout = null; }
    document.getElementById('infoStatusModal').classList.add('hidden'); document.body.style.overflow = '';
  }

  async function handleTripFormSubmit(event) {
    event.preventDefault();
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to submit the form.", "error"); return; }

    const startTimeValue = document.getElementById('trip_start_time_form').value;
    const endTimeValue = document.getElementById('trip_end_time_form').value;

    if (!startTimeValue) { openInfoStatusModal("Validation Error", "Start time is required.", "error"); return; }
    const startTimeObj = new Date(startTimeValue);
    let endTimeObj = null;
    if (endTimeValue) {
        endTimeObj = new Date(endTimeValue);
        if (endTimeObj <= startTimeObj) {
            openInfoStatusModal("Validation Error", "End time must be after start time.", "error"); return;
        }
    }

    const tripData = {
      vehicle_id: parseInt(document.getElementById('trip_vehicle_id_form').value),
      driver_id: parseInt(document.getElementById('trip_driver_id_form').value),
      start_location: document.getElementById('trip_start_location_form').value.trim(),
      end_location: document.getElementById('trip_end_location_form').value.trim(),
      start_time: startTimeObj.toISOString(),
      end_time: endTimeObj ? endTimeObj.toISOString() : null,
      purpose: document.getElementById('trip_purpose_form').value.trim() || null,
      status: document.getElementById('trip_status_form').value,
      notes: document.getElementById('trip_notes_form').value.trim() || null
    };

     if (isNaN(tripData.vehicle_id) || isNaN(tripData.driver_id) || !tripData.start_location || !tripData.end_location || !tripData.status) {
      openInfoStatusModal("Validation Error", "Please fill all required Trip fields: Vehicle, Driver, Start/End Location, Start Time, and Status.", "error"); return;
    }

    const actionType = tripToEditId ? "update" : "add";
    const confirmTitle = tripToEditId ? "Confirm Update" : "Confirm Add Trip";
    const confirmMessage = `Are you sure you want to ${actionType} this trip${tripToEditId ? "'s details" : ""}?`;
    const confirmBtnText = tripToEditId ? "Update" : "Add Trip";
    const confirmBtnIcon = tripToEditId ? "save" : "plus-circle";

    openGenericConfirmModal(
        confirmTitle, confirmMessage, confirmBtnText, confirmBtnIcon,
        async (dataForAction) => {
            let result;
            if (tripToEditId) { result = await apiRequest(`/trip/${tripToEditId}`, 'PUT', dataForAction); }
            else { result = await apiRequest('/trip/', 'POST', dataForAction); } 

            if (result) {
              openInfoStatusModal("Success", `Trip record ${tripToEditId ? 'updated' : 'added'} successfully!`, "success");
              closeAddTripModal();
              currentTripPage = tripToEditId ? currentTripPage : 1; 
              await fetchTrips();
            }
        },
        tripData
    );
  }

  function openConfirmDeleteTripModal(id) {
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to delete a trip.", "error"); return; }
      tripToDeleteId = id;

      openGenericConfirmModal(
        "Confirm Deletion",
        "Are you sure you want to permanently delete this trip record? This action cannot be undone.",
        "Delete",
        "trash-2",
        async () => {
            if (!tripToDeleteId) return;
            const result = await apiRequest(`/trip/${tripToDeleteId}`, 'DELETE');
            if (result) { 
                openInfoStatusModal("Success", "Trip record deleted successfully!", "success");
                if(allFetchedTripsFromServer.length === 1 && currentTripPage > 1) { 
                    currentTripPage--;
                }
                await fetchTrips();
            }
            tripToDeleteId = null;
        }
      );
  }

  // --- Date Filter Functions for Trips ---
  function applyTripDateFilter(filterType) {
    activeTripDateFilter = filterType;
    customTripFilterStartDate = null;
    customTripFilterEndDate = null;
    document.getElementById('tripCustomDateRange').classList.add('hidden');
    setActiveTripDateFilterButton(filterType);
    currentTripPage = 1;
    fetchTrips(); 
  }

  function toggleTripCustomDateRange() {
    document.getElementById('tripCustomDateRange').classList.toggle('hidden');
    if (!document.getElementById('tripCustomDateRange').classList.contains('hidden')) {
        setActiveTripDateFilterButton('trip-filter-custom-btn');
    } else if (activeTripDateFilter === 'custom') {
        applyTripDateFilter('all'); 
    }
  }

  function applyTripCustomDateFilter() {
    const startDate = document.getElementById('tripCustomStartDate').value;
    const endDate = document.getElementById('tripCustomEndDate').value;
    if (!startDate || !endDate) { openInfoStatusModal("Input Error", "Please select both start and end dates for the trip filter.", "error"); return; }
    if (new Date(startDate) > new Date(endDate)) { openInfoStatusModal("Input Error", "Start date cannot be after end date.", "error"); return; }

    activeTripDateFilter = 'custom';
    customTripFilterStartDate = startDate;
    customTripFilterEndDate = endDate;
    setActiveTripDateFilterButton('trip-filter-custom-btn');
    currentTripPage = 1;
    fetchTrips();
  }

  function getTripExportData() {
    let recordsToExport = [...allFetchedTripsFromServer];
    if (activeTripDateFilter !== 'all') {
        let range = (activeTripDateFilter === 'custom' && customTripFilterStartDate && customTripFilterEndDate)
                    ? { startDate: customTripFilterStartDate, endDate: customTripFilterEndDate }
                    : getDateRangeForFilter(activeTripDateFilter);
        if (range.startDate && range.endDate) {
            recordsToExport = recordsToExport.filter(r => {
                if (!r.start_time) return false;
                const recordStartDate = getISODateString(new Date(r.start_time));
                return recordStartDate >= range.startDate && recordStartDate <= range.endDate;
            });
        }
    }
    const searchTerm = document.getElementById('tripSearch').value.toLowerCase();
    if (searchTerm) {
        recordsToExport = recordsToExport.filter(r =>
            (r.id && r.id.toString().includes(searchTerm)) ||
            (r.start_location && r.start_location.toLowerCase().includes(searchTerm)) ||
            (r.end_location && r.end_location.toLowerCase().includes(searchTerm)) ||
            (r.purpose && r.purpose.toLowerCase().includes(searchTerm)) ||
            (r.status && r.status.toLowerCase().includes(searchTerm)) ||
            (vehicleDataForDropdown.find(v => v.id === r.vehicle_id)?.plate_number.toLowerCase().includes(searchTerm)) ||
            (driverDataForDropdown.find(d => d.id === r.driver_id)?.first_name.toLowerCase().includes(searchTerm))
        );
    }
    return recordsToExport;
  }

  function exportTripsExcel() {
    if (!getAuthToken() && allFetchedTripsFromServer.length === 0) {
        openInfoStatusModal("Export Error", "Please log in to export trip data, or ensure data is loaded.", "error"); return;
    }
    const recordsToExport = getTripExportData();
    if (recordsToExport.length === 0) { openInfoStatusModal("Export Info", "No trip data to export based on current filters.", "info"); return; }

    const wsData = recordsToExport.map(r => {
        const vehicle = vehicleDataForDropdown.find(v => v.id === r.vehicle_id);
        const driver = driverDataForDropdown.find(d => d.id === r.driver_id);
        return {
        'ID': r.id,
        'Vehicle Plate': vehicle ? vehicle.plate_number : `ID ${r.vehicle_id}`,
        'Driver Name': driver ? `${driver.first_name} ${driver.last_name}` : `ID ${r.driver_id}`,
        'Start Location': r.start_location,
        'End Location': r.end_location,
        'Start Time': formatDateTimeForDisplay(r.start_time),
        'End Time': formatDateTimeForDisplay(r.end_time),
        'Purpose': r.purpose,
        'Status': r.status,
        'Notes': r.notes,
        'Created At': formatDateTimeForDisplay(r.created_at || r.registration_date)
    }});
    const ws = XLSX.utils.json_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Trips");
    XLSX.writeFile(wb, "trips_export.xlsx");
  }

  function exportTripsPDF() {
    if (!getAuthToken() && allFetchedTripsFromServer.length === 0) {
        openInfoStatusModal("Export Error", "Please log in to export trip data, or ensure data is loaded.", "error"); return;
    }
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF('l'); 
    doc.setFontSize(18); doc.text('Trip Records', 14, 15);

    const recordsToExport = getTripExportData();
    if (recordsToExport.length === 0) { openInfoStatusModal("Export Info", "No trip data to export based on current filters.", "info"); return; }

    const headers = [['ID', 'Vehicle', 'Driver', 'Start Loc', 'End Loc', 'Start Time', 'Status']];
    const data = recordsToExport.map(r => {
        const vehicle = vehicleDataForDropdown.find(v => v.id === r.vehicle_id);
        const driver = driverDataForDropdown.find(d => d.id === r.driver_id);
        return [
        r.id,
        vehicle ? vehicle.plate_number : `VID:${r.vehicle_id}`,
        driver ? `${driver.first_name.substring(0,1)}. ${driver.last_name}` : `DID:${r.driver_id}`,
        r.start_location.substring(0,15), 
        r.end_location.substring(0,15),   
        new Date(r.start_time).toLocaleDateString(), 
        r.status
    ]});

    doc.autoTable({
        head: headers, body: data, startY: 25, theme:'grid',
        headStyles:{fillColor:[59,130,246], textColor:255},
        columnStyles: { 0:{cellWidth: 10}, 1:{cellWidth:30}, 2:{cellWidth:30}, 3:{cellWidth:35}, 4:{cellWidth:35}, 5:{cellWidth:30}, 6:{cellWidth:25} }
    });
    doc.save('trips_export.pdf');
  }
</script>
</body>
</html>