<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Panne (Issue) Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    .date-filter-btn.active, .status-filter-btn.active { background-color: #3b82f6; color: white; }
    .dark .date-filter-btn.active, .dark .status-filter-btn.active { background-color: #60a5fa; }
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">

<!-- Main application wrapper -->
<div class="flex h-screen">

    <!-- Sidebar (Left) - Modified for responsiveness -->
    <aside id="sidebar" class="fixed inset-y-0 left-0 z-40 w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg 
                             transform -translate-x-full transition-transform duration-300 ease-in-out 
                             md:relative md:translate-x-0 md:shadow-lg md:border-r dark:border-gray-700 
                             flex flex-col flex-shrink-0">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
          <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
        </div>
        <!-- Close button for mobile sidebar -->
        <button id="sidebar-close-button" class="md:hidden text-gray-700 dark:text-gray-300 p-1 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <nav class="flex-1 overflow-y-auto">
        <ul class="space-y-2">
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i><a href="dashboard">Dashboard</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="pie-chart" class="w-5 h-5"></i><a href="analytics">Analytics</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="users" class="w-5 h-5"></i><a href="users">User</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="user" class="w-5 h-5"></i><a href="driver">Driver</a>
        </li>
        <li class="flex items-center space-x-3 text-blue-600 dark:text-blue-400 font-semibold bg-blue-50 dark:bg-gray-700 p-2 rounded-md transition-colors"> 
          <i data-lucide="alert-triangle" class="w-5 h-5"></i><a href="panne">Pannes (Issues)</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="car" class="w-5 h-5"></i><a href="vehicle">Vehicles</a>
        </li>
         <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="wrench" class="w-5 h-5"></i><a href="reparation">Reparation</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="droplet" class="w-5 h-5"></i><a href="fuel">Fuel</a>
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="tool" class="w-5 h-5"></i><a href="maintenance">Maintenance</a> <!-- Changed icon from settings to tool to match original intent -->
        </li>
        <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
          <i data-lucide="route" class="w-5 h-5"></i><a href="trip">Trip</a>
        </li>
      </ul>
      </nav>
       <div class="pt-4 border-t border-gray-200 dark:border-gray-700/50 mt-auto">
            <a href="#" id="global-logout-btn" class="flex items-center space-x-3 text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700/40 p-2.5 rounded-lg transition-colors">
                <i data-lucide="log-out" class="w-5 h-5"></i><span>Logout</span>
            </a>
       </div>
    </aside>

    <!-- Overlay for mobile menu -->
    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden md:hidden"></div>
    
    <!-- Content Area Wrapper (Header + Main Content + Right Sidebar) -->
    <div class="flex-1 flex flex-col overflow-hidden">
      
      <!-- Header (Mobile Hamburger, Desktop Title, Theme Toggle, User Info) -->
      <header class="bg-white dark:bg-gray-800 shadow p-3 flex justify-between items-center flex-shrink-0 h-16">
          <!-- Hamburger Menu Button - visible only on mobile -->
          <button id="mobile-menu-button" class="md:hidden text-gray-700 dark:text-gray-300 focus:outline-none p-2">
              <i data-lucide="menu" class="w-6 h-6"></i>
          </button>
          
          <!-- Mobile Title - visible only on mobile -->
          <div class="text-lg font-bold text-primary dark:text-primary-light md:hidden">
              FleetDash
          </div>

          <!-- Desktop Title/Context - hidden on mobile -->
          <div class="hidden md:block text-xl font-semibold text-gray-700 dark:text-gray-200">
              Panne (Issue) Management
          </div>
          
          <!-- Right side of header: Theme Toggle & User Info -->
          <div class="flex items-center space-x-3">
              <button id="theme-toggle-header" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 text-gray-600 dark:text-gray-300">
                  <!-- Icon will be set by JS -->
              </button>
              <!-- User info for desktop header - hidden on mobile -->
              <div class="hidden md:flex items-center space-x-2">
                  <div class="text-sm font-semibold" id="userDisplayNameHeader">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400">Admin</div>
              </div>
          </div>
      </header>

      <!-- Main scrollable content area (Main Page Content + Right Sidebar) -->
      <div class="flex-1 flex overflow-hidden">
        <main class="flex-1 overflow-y-auto p-6">
          <!-- Panne Table Section -->
          <section id="panne-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
              <h2 class="text-2xl font-semibold text-gray-800 dark:text-white mb-2 sm:mb-0">Records</h2>
              <div class="flex flex-wrap gap-2 items-center">
                <button id="openAddPanneModalButton" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
                  <i data-lucide="plus" class="w-4 h-4"></i> Add Panne
                </button>
                <input type="text" id="panneSearch" placeholder="Search (vehicle, category, status...)" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
              </div>
              <div class="flex flex-wrap gap-2 items-center">
                <button id="exportExcelButton" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
                <button id="exportPdfButton" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
              </div>
            </div>

            <div class="mb-4 flex flex-wrap items-center gap-x-4 gap-y-2">
              <div>
                <span class="text-sm font-medium mr-2">Filter by Panne Date:</span>
                <div class="inline-flex rounded-md shadow-sm" role="group">
                  <button id="panne-date-filter-today" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-l-md hover:bg-gray-100 dark:hover:bg-gray-700">Today</button>
                  <button id="panne-date-filter-last7" class="date-filter-btn px-3 py-1.5 text-sm border-t border-b dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Last 7 Days</button>
                  <button id="panne-date-filter-last30" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700">Last 30 Days</button>
                  <button id="panne-date-filter-all" class="date-filter-btn px-3 py-1.5 text-sm border-t border-b border-r dark:border-gray-600 hover:bg-gray-100 dark:hover:bg-gray-700 active">All Time</button>
                  <button id="panne-date-filter-custom-btn" class="date-filter-btn px-3 py-1.5 text-sm border dark:border-gray-600 rounded-r-md hover:bg-gray-100 dark:hover:bg-gray-700">Custom</button>
                </div>
              </div>
              <div>
                <span class="text-sm font-medium mr-2">Filter by Status:</span>
                <select id="panneStatusFilter" class="status-filter-select px-3 py-1.5 text-sm border dark:border-gray-600 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700 dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">All Statuses</option>
                  <option value="active">Active</option>
                  <option value="in_progress">In Progress</option>
                  <option value="resolved">Resolved</option>
                  <option value="closed">Closed</option>
                </select>
              </div>
            </div>
            <div id="panneCustomDateRange" class="mb-4 hidden items-center gap-2 p-3 border dark:border-gray-700 rounded-md bg-gray-50 dark:bg-gray-800/50">
              <input type="date" id="panneCustomStartDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <span class="text-sm">to</span>
              <input type="date" id="panneCustomEndDate" class="border dark:border-gray-600 rounded-md px-2 py-1.5 text-sm text-black dark:bg-gray-700 dark:text-white">
              <button id="applyCustomDateFilterButton" class="bg-blue-500 text-white px-3 py-1.5 text-sm rounded-md hover:bg-blue-600">Apply</button>
            </div>

            <div class="overflow-x-auto">
              <table id="pannesTable" class="w-full text-left text-sm">
                <thead>
                  <tr class="border-b dark:border-gray-700">
                    <th class="py-3 px-2 font-semibold">ID</th>
                    <th class="px-2 font-semibold">Vehicle</th>
                    <th class="px-2 font-semibold">Category</th>
                    <th class="px-2 font-semibold">Status</th>
                    <th class="px-2 font-semibold">Panne Date</th>
                    <th class="px-2 font-semibold text-center">Actions</th>
                  </tr>
                </thead>
                <tbody id="pannesBody"></tbody>
              </table>
            </div>
            <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
              <div class="text-sm text-gray-600 dark:text-gray-400" id="pannesCount"></div>
              <div class="flex items-center space-x-1" id="pannesPagination"></div>
            </div>
          </section>
        </main>

        <!-- Right Sidebar -->
        <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden lg:block flex-shrink-0 overflow-y-auto border-l dark:border-gray-700">
            <!-- Theme toggle moved to main header, user info here is for desktop right sidebar -->
            <div class="flex justify-end items-center"> <!-- Changed to justify-end for user info -->
              <!-- User Info (visible in Right Sidebar on LG screens) -->
              <div>
                  <div class="text-sm font-semibold text-right" id="userDisplayNameRightSidebar">User</div>
                  <div class="text-xs text-gray-500 dark:text-gray-400 text-right">Admin</div>
              </div>
            </div>
            <div><h4 class="font-bold mb-4 text-lg">Recent Updates</h4><div class="flex flex-col space-y-6 relative"><div class="absolute left-5 top-0 bottom-0 w-0.5 bg-blue-500"></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">New panne reported</p><p class="text-sm text-gray-500 dark:text-gray-400">5 minutes ago</p></div></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">Panne status updated</p><p class="text-sm text-gray-500 dark:text-gray-400">1 hour ago</p></div></div></div></div>
            <div class="mt-8"><h4 class="font-bold mb-4 text-lg">Quick Actions</h4><div class="grid grid-cols-2 gap-2"><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="alert-octagon" class="w-5 h-5 mb-1"></i><span class="text-xs">Report Issue</span></button><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="search" class="w-5 h-5 mb-1"></i><span class="text-xs">Find Issue</span></button></div></div>
        </aside>
      </div>
    </div>
</div>


<!-- Add/Edit Panne Modal -->
<div id="addPanneModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="panneModalTitle">Add New Panne</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the panne (issue) details below</p>
        </div>
        <button id="closeAddPanneModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addPanneForm" class="space-y-4">
        <input type="hidden" id="panneId_form">
        <div>
          <label for="panne_vehicle_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Vehicle</label>
          <select id="panne_vehicle_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="">Loading Vehicles...</option>
          </select>
        </div>
        <div>
          <label for="panne_category_id_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Panne Category</label>
          <select id="panne_category_id_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="">Loading Categories...</option>
          </select>
        </div>
        <div>
          <label for="panne_description_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
          <textarea id="panne_description_form" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white" placeholder="Describe the issue..."></textarea>
        </div>
        <div>
          <label for="panne_status_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
          <select id="panne_status_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
            <option value="active">Active</option>
            <option value="in_progress">In Progress</option>
            <option value="resolved">Resolved</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <label for="panne_date_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Panne Date</label>
          <input type="datetime-local" id="panne_date_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:text-white">
        </div>
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" id="cancelAddPanneModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="panneSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Panne
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Panne Record Modal -->
<div id="viewPanneModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Panne (Issue) Details</h3>
        <button id="closeViewPanneModalButtonTop" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewPanneDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-x-4 gap-y-2">
            <span class="view-detail-label sm:col-span-1">Panne ID:</span><span id="view-panne-id" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Vehicle:</span><span id="view-panne-vehicle" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Category:</span><span id="view-panne-category" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Description:</span><span id="view-panne-description" class="view-detail-value sm:col-span-2 whitespace-pre-wrap"></span>
            <span class="view-detail-label sm:col-span-1">Status:</span><span id="view-panne-status" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Panne Date:</span><span id="view-panne-panne_date" class="view-detail-value sm:col-span-2"></span>
            <span class="view-detail-label sm:col-span-1">Reported At:</span><span id="view-panne-created_at" class="view-detail-value sm:col-span-2"></span>
        </div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" id="closeViewPanneModalButtonBottom" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal -->
<div id="genericConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirm Action</h3>
        <button id="closeGenericConfirmModalButtonX" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Are you sure?</p>
      <div class="flex justify-end gap-3 pt-4">
        <button id="cancelGenericConfirmModalButton" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
        <button id="genericConfirmModalConfirmBtn" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
          {/* Content set by JS */} Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Information/Status Modal -->
<div id="infoStatusModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
        {/* Icon set by JS */}
      </div>
      <h3 id="infoStatusModalTitle" class="text-lg font-medium text-gray-900 dark:text-white mb-2">Status</h3>
      <div class="mt-2">
        <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message.</p>
      </div>
      <div class="mt-5 sm:mt-6">
        <button type="button" id="infoStatusModalOkButton" class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">OK</button>
      </div>
    </div>
  </div>
</div>


<script>
  const API_BASE_URL = 'http://34.201.67.218:8000';
  const LOGIN_PAGE_URL = 'login.html';

  // --- Authentication Helper ---
  function getAuthToken() { return localStorage.getItem('accessToken'); }
  function parseJwt(token) { try { return JSON.parse(atob(token.split('.')[1])); } catch (e) { console.error("JWT Parse Error:", e); return null; }}

  function updateUserInfoDisplay() {
    const token = getAuthToken();
    const userDisplayElements = [
        document.getElementById('userDisplayNameHeader'),
        document.getElementById('userDisplayNameRightSidebar')
    ];

    userDisplayElements.forEach(userDisplayElement => {
        if (!userDisplayElement) return;
        if (token) {
            const decoded = parseJwt(token);
            userDisplayElement.textContent = (decoded && decoded.sub) ? decoded.sub : 'User (Authenticated)';
        } else {
            userDisplayElement.textContent = 'Guest';
        }
    });
  }

  async function apiRequest(endpoint, method = 'GET', body = null) {
    const token = getAuthToken();
    const headers = { 'Content-Type': 'application/json' };
    const publicGetEndpoints = ['/vehicle/', '/category_panne/'];
    const isPublicGet = publicGetEndpoints.some(publicEp => endpoint.startsWith(publicEp) && method === 'GET');

    if (token && !isPublicGet) {
         headers['Authorization'] = `Bearer ${token}`;
    } else if (!token && !isPublicGet && !endpoint.startsWith('/login')) {
        console.warn(`WARN: Protected endpoint ${endpoint} called without token.`);
    }

    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      if (response.status === 401 && !isPublicGet && !endpoint.endsWith('/login/')) {
        openInfoStatusModal("Authentication Error", "Session expired or unauthorized. Please log in again.", "error", 5000);
        return null;
      }
      if (response.status === 204) return true; 

      const responseData = await response.json().catch(async () => { 
          const text = await response.text(); 
          console.error(`JSON Parse Error for ${endpoint}. Status: ${response.status}. Response Text (first 100 chars): ${text.substring(0,100)}...`);
          if (!response.ok) { 
              return Promise.reject({ detail: text || `Server error ${response.status}` });
          }
          throw new Error(`Invalid JSON response from server (status ${response.status}). Check console for raw response.`);
      });

      if (!response.ok) {
        const errorDetail = responseData.detail || (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData) || 'Unknown server error.';
        console.error(`API Error for ${endpoint}: ${response.status}`, errorDetail);
         if (!(response.status === 401 && endpoint.endsWith('/login/'))) { 
            openInfoStatusModal(`API Error: ${response.status}`, errorDetail, "error");
        }
        return null;
      }
      return responseData;
    } catch (error) { 
      console.error(`Network/Catch Error during API request to ${endpoint}:`, error);
      const errorMessage = error.detail || error.message || "A network or request error occurred.";
      openInfoStatusModal("Request Error", errorMessage, "error");
      return null;
    }
  }

  // --- Global Variables ---
  let allPannes = [];
  const pannesPerPage = 10;
  let currentPannePage = 1;
  let panneToEditId = null;
  let activePanneDateFilter = 'all';
  let customPanneFilterStartDate = null;
  let customPanneFilterEndDate = null;
  let activePanneStatusFilter = '';
  let allVehiclesForDropdown = [];
  let allPanneCategoriesForDropdown = [];
  let currentConfirmAction = null;
  let currentActionData = null;
  let infoStatusModalTimeout = null;

  // --- Sidebar Toggle Functionality ---
  const sidebar = document.getElementById('sidebar');
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const sidebarCloseButton = document.getElementById('sidebar-close-button');
  const sidebarOverlay = document.getElementById('sidebar-overlay');

  function openMobileMenu() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.remove('-translate-x-full');
        sidebar.classList.add('translate-x-0');
        sidebarOverlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden', 'md:overflow-auto');
    }
  }

  function closeMobileMenu() {
    if (sidebar && sidebarOverlay) {
        sidebar.classList.add('-translate-x-full');
        sidebar.classList.remove('translate-x-0');
        sidebarOverlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden'); // Always remove this, md:overflow-auto is CSS based
    }
  }
  
  // --- Theme Toggle ---
  const themeToggleButton = document.getElementById('theme-toggle-header');
  function setInitialThemeIcon() {
    if (themeToggleButton) {
        if (document.documentElement.classList.contains('dark')) {
            themeToggleButton.innerHTML = '<i data-lucide="sun" class="w-5 h-5"></i>';
        } else {
            themeToggleButton.innerHTML = '<i data-lucide="moon" class="w-5 h-5"></i>';
        }
        lucide.createIcons();
    }
  }

  // --- MODAL CONTROL ---
  function closeModal(modalId) {
    document.getElementById(modalId).classList.add('hidden');
    document.body.style.overflow = '';
  }
  function openModal(modalId) {
    document.getElementById(modalId).classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }
  function closeAddPanneModal() {
    closeModal('addPanneModal');
    panneToEditId = null;
    document.getElementById('addPanneForm').reset();
    const submitButton = document.getElementById('panneSubmitButton');
    if (submitButton) submitButton.disabled = false;
  }
  function closeViewPanneModal() { closeModal('viewPanneModal'); }
  function closeGenericConfirmModal() {
    closeModal('genericConfirmModal');
    currentConfirmAction = null; currentActionData = null;
  }
  function closeInfoStatusModal() {
    if (infoStatusModalTimeout) { clearTimeout(infoStatusModalTimeout); infoStatusModalTimeout = null; }
    closeModal('infoStatusModal');
  }

  function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIcon, onConfirmCallback, actionData = null) {
    document.getElementById('genericConfirmModalTitle').textContent = title;
    document.getElementById('genericConfirmModalMessage').textContent = message;
    const confirmBtn = document.getElementById('genericConfirmModalConfirmBtn');
    confirmBtn.innerHTML = `<i data-lucide="${confirmButtonIcon || 'check-circle'}" class="w-4 h-4 mr-1"></i> ${confirmButtonText || 'Confirm'}`;
    confirmBtn.className = `px-4 py-2 text-white rounded-lg flex items-center gap-2 ${
        confirmButtonIcon === 'trash-2' ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-500 hover:bg-blue-600'
    }`;
    lucide.createIcons();
    currentConfirmAction = onConfirmCallback; currentActionData = actionData;
    openModal('genericConfirmModal');
  }

  function openInfoStatusModal(title, message, type = 'success', autoCloseDelay = 3000) {
    const titleEl = document.getElementById('infoStatusModalTitle');
    const messageEl = document.getElementById('infoStatusModalMessage');
    const iconContainer = document.getElementById('infoStatusModalIconContainer');
    const okButton = document.getElementById('infoStatusModalOkButton');

    titleEl.textContent = title; messageEl.textContent = message;
    if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout);

    let iconName = 'info', iconColorClass = 'text-blue-600', bgColorClass = 'bg-blue-100', btnClass = 'bg-blue-600 hover:bg-blue-700 focus:ring-blue-500';
    if (type === 'success') {
        iconName = 'check'; iconColorClass = 'text-green-600'; bgColorClass = 'bg-green-100'; btnClass = 'bg-green-600 hover:bg-green-700 focus:ring-green-500';
    } else if (type === 'error') {
        iconName = 'x-circle'; iconColorClass = 'text-red-600'; bgColorClass = 'bg-red-100'; btnClass = 'bg-red-600 hover:bg-red-700 focus:ring-red-500';
    }
    iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${bgColorClass} mb-4`;
    iconContainer.innerHTML = `<i data-lucide="${iconName}" class="h-6 w-6 ${iconColorClass}"></i>`;
    okButton.className = `inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white ${btnClass} focus:outline-none focus:ring-2 focus:ring-offset-2 sm:text-sm`;
    lucide.createIcons();
    openModal('infoStatusModal');
    if (autoCloseDelay > 0) {
        infoStatusModalTimeout = setTimeout(closeInfoStatusModal, autoCloseDelay);
    }
  }

  // --- DOMContentLoaded & Event Listeners ---
  document.addEventListener('DOMContentLoaded', async () => {
      console.log("DOM fully loaded and main script running."); 
      lucide.createIcons();
      updateUserInfoDisplay();
      
      // Theme Toggle (now in header)
      themeToggleButton?.addEventListener('click', () => {
        document.documentElement.classList.toggle('dark');
        setInitialThemeIcon(); 
      });
      setInitialThemeIcon(); 

      // Sidebar Toggle Listeners
      mobileMenuButton?.addEventListener('click', openMobileMenu);
      sidebarCloseButton?.addEventListener('click', closeMobileMenu);
      sidebarOverlay?.addEventListener('click', closeMobileMenu);
      document.querySelectorAll('#sidebar nav a').forEach(link => {
          link.addEventListener('click', () => {
              if (window.innerWidth < 768) { // md breakpoint
                  closeMobileMenu();
              }
          });
      });

      ['addPanneModal', 'viewPanneModal', 'genericConfirmModal'].forEach(modalId => {
        document.getElementById(modalId)?.addEventListener('click', e => { if (e.target.id === modalId) closeModal(modalId); });
      });
      document.getElementById('infoStatusModal')?.addEventListener('click', e => { if (e.target.id === 'infoStatusModal' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });

      document.getElementById('closeAddPanneModalButtonTop')?.addEventListener('click', closeAddPanneModal);
      document.getElementById('cancelAddPanneModalButton')?.addEventListener('click', closeAddPanneModal);
      document.getElementById('closeViewPanneModalButtonTop')?.addEventListener('click', closeViewPanneModal);
      document.getElementById('closeViewPanneModalButtonBottom')?.addEventListener('click', closeViewPanneModal);
      document.getElementById('closeGenericConfirmModalButtonX')?.addEventListener('click', closeGenericConfirmModal);
      document.getElementById('cancelGenericConfirmModalButton')?.addEventListener('click', () => {
          closeGenericConfirmModal();
          const panneSubmitButton = document.getElementById('panneSubmitButton');
          if (panneSubmitButton && !document.getElementById('addPanneModal').classList.contains('hidden')) {
               panneSubmitButton.disabled = false;
          }
      });

      document.getElementById('genericConfirmModalConfirmBtn')?.addEventListener('click', async () => {
        if (typeof currentConfirmAction === 'function') {
             try { await currentConfirmAction(currentActionData); }
             catch (error) {
                console.error("Error in currentConfirmAction:", error);
                const panneSubmitButton = document.getElementById('panneSubmitButton');
                if (panneSubmitButton && !document.getElementById('addPanneModal').classList.contains('hidden')) {
                     panneSubmitButton.disabled = false;
                }
             }
        }
        closeGenericConfirmModal();
      });

      const handleLogout = (e) => {
          e.preventDefault();
          localStorage.removeItem('accessToken');
          openInfoStatusModal('Logged Out', 'You have been successfully logged out.', 'success', 2500);
          updateUserInfoDisplay(); allPannes = [];
          fetchAndRenderPannes();
      };
      document.getElementById('global-logout-btn')?.addEventListener('click', handleLogout);

      document.getElementById('openAddPanneModalButton')?.addEventListener('click', openAddPanneModal);
      document.getElementById('exportExcelButton')?.addEventListener('click', exportPannesExcel);
      document.getElementById('exportPdfButton')?.addEventListener('click', exportPannesPDF);
      document.getElementById('panneSearch')?.addEventListener('input', () => { currentPannePage = 1; fetchAndRenderPannes(); });
      document.getElementById('panneStatusFilter')?.addEventListener('change', (event) => applyPanneStatusFilter(event.target.value));

      document.getElementById('panne-date-filter-today')?.addEventListener('click', () => applyPanneDateFilter('today'));
      document.getElementById('panne-date-filter-last7')?.addEventListener('click', () => applyPanneDateFilter('last7days'));
      document.getElementById('panne-date-filter-last30')?.addEventListener('click', () => applyPanneDateFilter('last30days'));
      document.getElementById('panne-date-filter-all')?.addEventListener('click', () => applyPanneDateFilter('all'));
      document.getElementById('panne-date-filter-custom-btn')?.addEventListener('click', togglePanneCustomDateRange);
      document.getElementById('applyCustomDateFilterButton')?.addEventListener('click', applyPanneCustomDateFilter);

      document.getElementById('addPanneForm')?.addEventListener('submit', handlePanneFormSubmit);

      await initializePanneSection();
  });

  // --- Date Helper Functions ---
  function getISODateString(date) {
      if (!date) return null;
      const d = new Date(date);
      return d.getFullYear() + '-' + ('0' + (d.getMonth() + 1)).slice(-2) + '-' + ('0' + d.getDate()).slice(-2);
  }
  function getISODateTimeString(date) {
      if (!date) return null;
      const d = new Date(date);
      return `${d.getFullYear()}-${('0'+(d.getMonth()+1)).slice(-2)}-${('0'+d.getDate()).slice(-2)}T${('0'+d.getHours()).slice(-2)}:${('0'+d.getMinutes()).slice(-2)}`;
  }
  function getDateRange(filterType) {
    const today = new Date(); today.setHours(0,0,0,0);
    let sD = new Date(today), eD = new Date(today); eD.setHours(23,59,59,999);
    if (filterType === 'last7days') sD.setDate(today.getDate()-6);
    else if (filterType === 'last30days') sD.setDate(today.getDate()-29);
    else if (filterType === 'all') return {startDate:null,endDate:null}; 
    return {startDate:getISODateString(sD),endDate:getISODateString(eD)};
  }

  // --- Initialization & Dropdown Population ---
  async function initializePanneSection() {
    await populatePanneLookupData();
    await fetchAndRenderPannes({isInitialLoadForGuest: !getAuthToken()});
    setActivePanneDateFilterButton('all');
    document.getElementById('panneStatusFilter').value = '';
  }

  async function populatePanneLookupData() {
    allVehiclesForDropdown = await apiRequest('/vehicle/?limit=1000') || [];
    allPanneCategoriesForDropdown = await apiRequest('/category_panne/?limit=200') || [];
    populatePanneDropdowns();
  }

  function populatePanneDropdowns() {
    const populateSelect = (selectId, data, valueField, displayFields, placeholder) => {
        const select = document.getElementById(selectId);
        if (!select) { console.error(`Select element ${selectId} not found.`); return; }
        select.innerHTML = `<option value="">${placeholder}</option>`;
        (data || []).forEach(item => {
            const option = document.createElement('option');
            option.value = item[valueField];
            let textContent = displayFields.map(fieldKey => {
                // For nested properties like vehicle.make
                let val = item;
                fieldKey.split('.').forEach(key => { val = val ? val[key] : undefined; });
                return val || (fieldKey.includes('plate_number') ? 'N/A Plate' : (fieldKey.includes('panne_name') ? 'N/A Category' : 'N/A'));
            }).join(' - ');

            if (textContent.includes('N/A Category') || textContent.includes('N/A Plate') || textContent === 'N/A') {
                 option.textContent = `${textContent.replace('N/A Category', 'Cat. N/A').replace('N/A Plate', 'Plate N/A')} (ID: ${item[valueField]})`;
            } else {
                 option.textContent = textContent;
            }
            select.appendChild(option);
        });
    };
    // Use a more descriptive display for vehicles, including make, model, and plate
    populateSelect('panne_vehicle_id_form', allVehiclesForDropdown, 'id', ['make', 'model', 'plate_number'], 'Select Vehicle');
    populateSelect('panne_category_id_form', allPanneCategoriesForDropdown, 'id', ['panne_name'], 'Select Panne Category');
  }

  // --- Filter Logic ---
  function applyPanneDateFilter(filterType) {
    activePanneDateFilter = filterType; customPanneFilterStartDate = null; customPanneFilterEndDate = null;
    document.getElementById('panneCustomDateRange').classList.add('hidden');
    setActivePanneDateFilterButton(filterType); currentPannePage = 1;
    fetchAndRenderPannes();
  }
  function togglePanneCustomDateRange() {
    document.getElementById('panneCustomDateRange').classList.toggle('hidden');
    if (!document.getElementById('panneCustomDateRange').classList.contains('hidden')) setActivePanneDateFilterButton('panne-date-filter-custom-btn');
    else if (activePanneDateFilter === 'custom') applyPanneDateFilter('all');
  }
  function applyPanneCustomDateFilter() {
    const startDate = document.getElementById('panneCustomStartDate').value;
    const endDate = document.getElementById('panneCustomEndDate').value;
    if (!startDate || !endDate) { openInfoStatusModal("Input Error","Please select both start and end dates.", "error"); return; }
    if (new Date(startDate) > new Date(endDate)) { openInfoStatusModal("Input Error", "Start date cannot be after end date.", "error"); return; }
    activePanneDateFilter = 'custom'; customPanneFilterStartDate = startDate; customPanneFilterEndDate = endDate;
    setActivePanneDateFilterButton('panne-date-filter-custom-btn'); currentPannePage = 1;
    fetchAndRenderPannes();
  }
  function applyPanneStatusFilter(statusValue) {
      activePanneStatusFilter = statusValue; currentPannePage = 1; fetchAndRenderPannes();
  }
  function setActivePanneDateFilterButton(filterId) {
    document.querySelectorAll('#panne-section .date-filter-btn').forEach(btn => btn.classList.remove('active'));
    const activeBtn = document.getElementById(filterId.startsWith('panne-date-filter-') ? filterId : `panne-date-filter-${filterId}`);
    if (activeBtn) activeBtn.classList.add('active');
  }

  // --- CRUD & Table Rendering ---
  async function fetchAndRenderPannes(options = {}) {
    if (!getAuthToken() && !options.isInitialLoadForGuest) {
        allPannes = []; renderPannesTable(); return;
    }
    let queryParams = `skip=${(currentPannePage - 1) * pannesPerPage}&limit=${pannesPerPage}`;
    const searchTerm = document.getElementById('panneSearch').value;
    if (searchTerm) queryParams += `&search=${encodeURIComponent(searchTerm)}`;
    if (activePanneStatusFilter) queryParams += `&status=${encodeURIComponent(activePanneStatusFilter)}`;
    let range = getDateRange(activePanneDateFilter); 
    if (activePanneDateFilter === 'custom' && customPanneFilterStartDate && customPanneFilterEndDate) {
        range = { startDate: customPanneFilterStartDate, endDate: customPanneFilterEndDate };
    }
    if (range?.startDate) queryParams += `&start_date=${encodeURIComponent(range.startDate)}`;
    if (range?.endDate) queryParams += `&end_date=${encodeURIComponent(range.endDate)}`;

    const data = await apiRequest(`/panne/?${queryParams}`);
    allPannes = Array.isArray(data) ? data : [];
    renderPannesTable();
  }

  function renderPannesTable() {
    const pannesBody = document.getElementById('pannesBody');
    if (!getAuthToken() && allPannes.length === 0) {
        pannesBody.innerHTML = `<tr><td colspan="6" class="text-center py-8 text-red-500">Please log in to view panne records.</td></tr>`;
        document.getElementById('pannesCount').textContent = '0 records';
        document.getElementById('pannesPagination').innerHTML = '';
        return;
    }
    const recordsToDisplay = allPannes;
    pannesBody.innerHTML = recordsToDisplay.length > 0 ? recordsToDisplay.map(p => {
      const vehicleDisplay = p.vehicle ? `${p.vehicle.make || 'N/A'} ${p.vehicle.model || 'N/A'} (${p.vehicle.plate_number || 'N/A Plate'})` : 'Vehicle N/A';
      const categoryDisplay = p.category_panne && p.category_panne.panne_name ? p.category_panne.panne_name : 'Category N/A';
      const statusFormatted = p.status.charAt(0).toUpperCase() + p.status.slice(1).replace(/_/g, ' ');
      const statusColor = p.status === "active" ? "bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200" :
                          p.status === "in_progress" ? "bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200" :
                          p.status === "resolved" ? "bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200" :
                          p.status === "closed" ? "bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300" :
                          "bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200";
      return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${p.id}">
                <td class="py-3 px-2">${p.id}</td>
                <td class="px-2">${vehicleDisplay}</td>
                <td class="px-2">${categoryDisplay}</td>
                <td class="px-2"><span class="px-2 py-1 text-xs font-medium rounded-full ${statusColor}">${statusFormatted}</span></td>
                <td class="px-2">${new Date(p.panne_date).toLocaleString()}</td>
                <td class="px-2 text-center whitespace-nowrap">
                  <button onclick="openViewPanneModal(${p.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                  <button onclick="openEditPanneModal(${p.id})" class="text-blue-600 dark:text-blue-400 p-1 ml-1" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                  <button onclick="openConfirmDeletePanneModal(${p.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </td></tr>`;
    }).join('') : `<tr><td colspan="6" class="text-center py-8 text-gray-500">No panne records found${document.getElementById('panneSearch').value || activePanneDateFilter !== 'all' || activePanneStatusFilter ? ' matching criteria.' : (allPannes.length === 0 && getAuthToken() ? '. Try adding one!' : '')}</td></tr>`;
    lucide.createIcons();
    const startRecord = (currentPannePage - 1) * pannesPerPage + 1;
    const endRecord = (currentPannePage - 1) * pannesPerPage + recordsToDisplay.length;
    document.getElementById('pannesCount').textContent = recordsToDisplay.length > 0 ? `Showing ${startRecord} to ${endRecord}` : '0 records';
    renderPannesPagination(recordsToDisplay.length === pannesPerPage);
  }

  function renderPannesPagination(hasNextPage) {
    const paginationContainer = document.getElementById('pannesPagination');
    paginationContainer.innerHTML = '';
    if (currentPannePage === 1 && !hasNextPage && allPannes.length === 0) return;
    const btnClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";
    const itemClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";
    const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";
    const prevButton = Object.assign(document.createElement('button'), {
        innerHTML: `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`,
        className: `${btnClasses} ${currentPannePage === 1 ? disabledClasses : itemClasses}`,
        disabled: currentPannePage === 1,
        onclick: () => { if(currentPannePage > 1) {currentPannePage--; fetchAndRenderPannes();} }
    });
    const pageInfo = Object.assign(document.createElement('span'), {
        className: "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400", textContent: `Page ${currentPannePage}`
    });
    const nextButton = Object.assign(document.createElement('button'), {
        innerHTML: `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`,
        className: `${btnClasses} ${!hasNextPage ? disabledClasses : itemClasses}`,
        disabled: !hasNextPage,
        onclick: () => { if(hasNextPage) {currentPannePage++; fetchAndRenderPannes();} }
    });
    paginationContainer.append(prevButton, pageInfo, nextButton);
    lucide.createIcons();
  }

  // --- Modal Operations (Add/Edit/View) ---
  function openAddPanneModal() {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to add a panne record.", "error"); return; }
    panneToEditId = null;
    document.getElementById('addPanneForm').reset();
    document.getElementById('panneModalTitle').textContent = "Add New Panne (Issue)";
    document.getElementById('panneSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4 mr-1"></i> Add Panne`;
    document.getElementById('panneSubmitButton').disabled = false;
    document.getElementById('panne_date_form').value = getISODateTimeString(new Date());
    lucide.createIcons();
    openModal('addPanneModal');
  }

  async function openEditPanneModal(id) {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to edit.", "error"); return; }
    const panne = await apiRequest(`/panne/${id}`);
    if (!panne) { openInfoStatusModal("Error","Could not fetch panne details.", "error"); return; }
    panneToEditId = id;
    document.getElementById('panneModalTitle').textContent = "Edit Panne (Issue) Record";
    document.getElementById('panneSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4 mr-1"></i> Save Changes`;
    document.getElementById('panneSubmitButton').disabled = false;
    document.getElementById('panneId_form').value = panne.id;
    document.getElementById('panne_vehicle_id_form').value = panne.vehicle_id;
    document.getElementById('panne_category_id_form').value = panne.category_panne_id;
    document.getElementById('panne_description_form').value = panne.description || '';
    document.getElementById('panne_status_form').value = panne.status;
    document.getElementById('panne_date_form').value = getISODateTimeString(new Date(panne.panne_date));
    lucide.createIcons();
    openModal('addPanneModal');
  }

  async function openViewPanneModal(id) {
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to view.", "error"); return; }
    const panne = await apiRequest(`/panne/${id}`);
    if (!panne) { openInfoStatusModal("Error", "Could not fetch panne details.", "error"); return; }
    const vehicleDisplay = panne.vehicle ? `${panne.vehicle.make || 'N/A'} ${panne.vehicle.model || 'N/A'} (${panne.vehicle.plate_number || 'N/A Plate'})` : 'N/A';
    const categoryDisplay = panne.category_panne && panne.category_panne.panne_name ? panne.category_panne.panne_name : 'N/A';
    document.getElementById('view-panne-id').textContent = panne.id;
    document.getElementById('view-panne-vehicle').textContent = vehicleDisplay;
    document.getElementById('view-panne-category').textContent = categoryDisplay;
    document.getElementById('view-panne-description').textContent = panne.description || 'N/A';
    document.getElementById('view-panne-status').textContent = panne.status.charAt(0).toUpperCase() + panne.status.slice(1).replace(/_/g, ' ');
    document.getElementById('view-panne-panne_date').textContent = new Date(panne.panne_date).toLocaleString();
    document.getElementById('view-panne-created_at').textContent = new Date(panne.created_at).toLocaleString();
    openModal('viewPanneModal');
  }

  async function handlePanneFormSubmit(event) {
    event.preventDefault();
    if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in.", "error"); return; }
    const submitButton = document.getElementById('panneSubmitButton');
    if (submitButton.disabled) return;
    submitButton.disabled = true;
    const panneDateValue = document.getElementById('panne_date_form').value;
    if (!panneDateValue) { openInfoStatusModal("Validation Error", "Panne Date is required.", "error"); submitButton.disabled = false; return; }
    const panneDateTime = new Date(panneDateValue);
    if (isNaN(panneDateTime.getTime())) { openInfoStatusModal("Validation Error", "Invalid Panne Date.", "error"); submitButton.disabled = false; return; }
    if (panneDateTime > new Date()) { openInfoStatusModal("Validation Error", "Panne Date cannot be in the future.", "error"); submitButton.disabled = false; return; }
    const formData = {
      vehicle_id: parseInt(document.getElementById('panne_vehicle_id_form').value),
      category_panne_id: parseInt(document.getElementById('panne_category_id_form').value),
      description: document.getElementById('panne_description_form').value.trim() || null,
      status: document.getElementById('panne_status_form').value,
      panne_date: panneDateTime.toISOString()
    };
    if (!formData.vehicle_id || !formData.category_panne_id || !formData.status ) {
      openInfoStatusModal("Validation Error", "Vehicle, Category, and Status are required.", "error"); submitButton.disabled = false; return;
    }
    const actionType = panneToEditId ? "update" : "add";
    openGenericConfirmModal( panneToEditId ? "Confirm Update" : "Confirm Add Panne",
        `Are you sure you want to ${actionType} this panne record?`,
        panneToEditId ? "Update" : "Add", panneToEditId ? "save" : "plus-circle",
        async (data) => {
            try {
                const result = panneToEditId ? await apiRequest(`/panne/${panneToEditId}`, 'PUT', data) : await apiRequest('/panne/', 'POST', data);
                if (result) {
                    openInfoStatusModal("Success", `Panne record ${actionType}d successfully!`, "success");
                    closeAddPanneModal();
                    await fetchAndRenderPannes();
                } else if (submitButton && !document.getElementById('addPanneModal').classList.contains('hidden')) {
                    submitButton.disabled = false;
                }
            } catch (error) {
                console.error(`Error during ${actionType} panne record:`, error);
                 if (submitButton && !document.getElementById('addPanneModal').classList.contains('hidden')) submitButton.disabled = false;
            }
        }, formData
    );
  }

  function openConfirmDeletePanneModal(id) {
      if (!getAuthToken()) { openInfoStatusModal("Authentication Required","Please log in to delete.", "error"); return; }
      openGenericConfirmModal( "Confirm Deletion", `Are you sure you want to permanently delete panne record ID: ${id}?`, "Delete", "trash-2",
        async (recordIdToDelete) => {
            const result = await apiRequest(`/panne/${recordIdToDelete}`, 'DELETE');
            if (result === true) {
                openInfoStatusModal("Success", `Panne record ID: ${recordIdToDelete} deleted.`, "success");
                if(allPannes.length === 1 && currentPannePage > 1) currentPannePage--;
                await fetchAndRenderPannes();
            }
        }, id
      );
  }

  // --- Export Functions ---
  async function getPannesForExport() {
    let queryParams = `limit=10000`; // Fetch a large number for export
    const searchTerm = document.getElementById('panneSearch').value;
    if (searchTerm) queryParams += `&search=${encodeURIComponent(searchTerm)}`;
    if (activePanneStatusFilter) queryParams += `&status=${encodeURIComponent(activePanneStatusFilter)}`;
    let range = getDateRange(activePanneDateFilter);
     if (activePanneDateFilter === 'custom' && customPanneFilterStartDate && customPanneFilterEndDate) {
        range = { startDate: customPanneFilterStartDate, endDate: customPanneFilterEndDate };
    }
    if (range?.startDate) queryParams += `&start_date=${encodeURIComponent(range.startDate)}`;
    if (range?.endDate) queryParams += `&end_date=${encodeURIComponent(range.endDate)}`;
    const data = await apiRequest(`/panne/?${queryParams}`);
    return Array.isArray(data) ? data : [];
  }

  async function exportPannesExcel() {
    if (!getAuthToken()) { openInfoStatusModal("Export Error", "Please log in to export data.", "error"); return; }
    if (typeof XLSX === 'undefined') { openInfoStatusModal("Error", "Excel library (XLSX) is not loaded.", "error"); return;}
    try {
        const recordsToExport = await getPannesForExport();
        if (!recordsToExport || recordsToExport.length === 0) { openInfoStatusModal("Info", "No data to export.", "info"); return; }
        const data = recordsToExport.map(p => ({
            ID: p.id,
            Vehicle: p.vehicle ? `${p.vehicle.make || ''} ${p.vehicle.model || ''} (${p.vehicle.plate_number || 'N/A'})` : 'N/A',
            Category: p.category_panne && p.category_panne.panne_name ? p.category_panne.panne_name : 'N/A',
            Description: p.description || '', Status: p.status,
            'Panne Date': new Date(p.panne_date).toLocaleString(), 'Reported At': new Date(p.created_at).toLocaleString()
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Pannes");
        XLSX.writeFile(wb, "pannes_issues_export.xlsx");
        openInfoStatusModal("Success", "Data exported to Excel.", "success");
    } catch (error) {
        console.error("Excel Export Error:", error);
        openInfoStatusModal("Export Error", `Failed to export to Excel: ${error.message || 'Unknown error'}.`, "error");
    }
  }

  async function exportPannesPDF() {
    if (!getAuthToken()) { openInfoStatusModal("Export Error", "Please log in to export data.", "error"); return;}
    if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') { openInfoStatusModal("Error", "PDF library (jsPDF) is not loaded.", "error"); return;}
    try {
        const recordsToExport = await getPannesForExport();
        if (!recordsToExport || recordsToExport.length === 0) { openInfoStatusModal("Info", "No data to export.", "info"); return;}
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l');
        if (typeof doc.autoTable !== 'function') { openInfoStatusModal("Error", "PDF AutoTable plugin is not loaded.", "error"); return;}

        doc.setFontSize(18); doc.text('Panne (Issue) Records', 14, 15);
        const headers = [['ID', 'Vehicle (Plate)', 'Category', 'Status', 'Panne Date']];
        const data = recordsToExport.map(p => [
            p.id,
            p.vehicle ? (p.vehicle.plate_number || 'N/A Plate') : 'N/A',
            p.category_panne && p.category_panne.panne_name ? p.category_panne.panne_name : 'N/A',
            p.status,
            new Date(p.panne_date).toLocaleDateString()
        ]);
        doc.autoTable({
            head: headers, body: data, startY: 25, theme:'grid',
            headStyles:{fillColor:[220, 53, 69], textColor:255}, // Example: Red header
            columnStyles: { 0:{cellWidth:15}, 1:{cellWidth:50}, 2:{cellWidth:50}, 3:{cellWidth:30}, 4:{cellWidth:40} }
        });
        doc.save('pannes_issues_export.pdf');
        openInfoStatusModal("Success", "Data exported to PDF.", "success");
    } catch (error) {
        console.error("PDF Export Error:", error);
        openInfoStatusModal("Export Error", `Failed to export to PDF: ${error.message || 'Unknown error'}.`, "error");
    }
  }
</script>
</body>
</html>