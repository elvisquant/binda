<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Driver Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script>
    tailwind.config = { darkMode: 'class' }
  </script>
  <style>
    .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
    .modal.hidden { visibility: hidden; opacity: 0; }
    .modal:not(.hidden) { visibility: visible; opacity: 1; }
    .dark .modal-content { box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5), 0 10px 10px -5px rgba(0,0,0,0.2); }
    /* No date filter buttons active style needed for drivers in this version */
    .view-detail-label { font-weight: 500; color: #4b5563; }
    .dark .view-detail-label { color: #d1d5db; }
    .view-detail-value { color: #1f2937; }
    .dark .view-detail-value { color: #f9fafb; }
  </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-white">
<div class="flex flex-col md:flex-row h-screen overflow-hidden">

    <!-- Sidebar (Left) -->
    <aside class="w-64 bg-white dark:bg-gray-800/95 backdrop-blur-sm p-4 space-y-6 shadow-lg hidden md:block flex-shrink-0 border-r dark:border-gray-700">
      <div class="text-2xl font-bold flex items-center space-x-2 text-primary dark:text-primary-light">
        <i data-lucide="command" class="w-7 h-7"></i><span>FleetDash</span>
      </div>
      <nav class="flex-1">
        <ul class="space-y-2">
            <li class="flex items-center space-x-3 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded-md transition-colors">
              <i data-lucide="user" class="w-5 h-5"></i><a href="driver">Driver Management</a>
            </li>
        </ul>
      </nav>
    </aside>

  <!-- Main content -->
  <main class="flex-1 overflow-auto p-6">
    <!-- Driver Table Section -->
    <section id="driver-section" class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow mb-6">
      <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-3">
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="openAddDriverModal()" class="bg-blue-500 text-white px-3 py-2 rounded-lg hover:bg-blue-600 flex items-center gap-1 text-sm shadow-sm">
            <i data-lucide="plus" class="w-4 h-4"></i> Add Driver
          </button>
          <input type="text" id="driverSearch" placeholder="Search drivers (name, CNI, email...)" class="border dark:border-gray-600 rounded-lg px-3 py-2 text-sm text-black dark:bg-gray-700 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full sm:w-auto">
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <button onclick="exportDriversExcel()" class="bg-green-500 text-white px-3 py-2 rounded-lg hover:bg-green-600 text-sm shadow-sm">ðŸ“„ Excel</button>
          <button onclick="exportDriversPDF()" class="bg-red-500 text-white px-3 py-2 rounded-lg hover:bg-red-600 text-sm shadow-sm">ðŸ§¾ PDF</button>
        </div>
      </div>

      <!-- No date filters for drivers in this version -->

      <div class="overflow-x-auto">
        <table id="driversTable" class="w-full text-left text-sm">
          <thead>
            <tr class="border-b dark:border-gray-700">
              <th class="py-3 px-2 font-semibold">ID</th>
              <th class="px-2 font-semibold">Full Name</th>
              <th class="px-2 font-semibold">Email</th>
              <th class="px-2 font-semibold">Matricule</th>
              <th class="px-2 font-semibold">CNI</th>
              <th class="px-2 font-semibold">Registered</th>
              <th class="px-2 font-semibold text-center">Actions</th>
            </tr>
          </thead>
          <tbody id="driversBody"></tbody>
        </table>
      </div>
      <div class="mt-6 flex flex-col sm:flex-row justify-between items-center space-y-3 sm:space-y-0">
        <div class="text-sm text-gray-600 dark:text-gray-400" id="driversCount"></div>
        <div class="flex items-center space-x-1" id="driversPagination"></div>
      </div>
    </section>
  </main>

    <!-- Right Sidebar (Copied, adjust content if needed) -->
    <aside class="w-1/5 bg-white dark:bg-gray-800 p-4 space-y-6 shadow-md hidden lg:block flex-shrink-0">
        <div class="flex justify-between items-center">
        <button id="theme-toggle" class="text-xl p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">ðŸŒ™</button>
        </div>
        <div><h4 class="font-bold mb-4 text-lg">Recent Driver Activity</h4><div class="flex flex-col space-y-6 relative"><div class="absolute left-5 top-0 bottom-0 w-0.5 bg-blue-500"></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">New driver added</p><p class="text-sm text-gray-500 dark:text-gray-400">1 hour ago</p></div></div><div class="flex items-start space-x-4 relative"><div class="w-3 h-3 bg-blue-500 rounded-full z-10 mt-1.5 ml-4"></div><div class="ml-2"><p class="font-medium">Driver profile updated</p><p class="text-sm text-gray-500 dark:text-gray-400">3 hours ago</p></div></div></div></div>
        <div class="mt-8"><h4 class="font-bold mb-4 text-lg">Quick Actions</h4><div class="grid grid-cols-2 gap-2"><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="user-check" class="w-5 h-5 mb-1"></i><span class="text-xs">Verify Driver</span></button><button class="p-2 bg-gray-100 dark:bg-gray-700 rounded-lg flex flex-col items-center hover:bg-gray-200 dark:hover:bg-gray-600"><i data-lucide="search" class="w-5 h-5 mb-1"></i><span class="text-xs">Find Driver</span></button></div></div>
    </aside>
</div>

<!-- Add/Edit Driver Modal -->
<div id="addDriverModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <div>
          <h3 class="text-xl font-bold text-gray-800 dark:text-white" id="driverModalTitle">Add New Driver</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">Fill in the driver details below</p>
        </div>
        <button onclick="closeAddDriverModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <form id="addDriverForm" class="space-y-4">
        <input type="hidden" id="driverId_form">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="driver_first_name_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
              <input type="text" id="driver_first_name_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., John">
            </div>
            <div>
              <label for="driver_last_name_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
              <input type="text" id="driver_last_name_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., Doe">
            </div>
        </div>
        <div>
            <label for="driver_email_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email Address</label>
            <input type="email" id="driver_email_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., john.doe@example.com">
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="driver_cni_number_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">CNI Number</label>
              <input type="text" id="driver_cni_number_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="National ID Card Number">
            </div>
            <div>
              <label for="driver_matricule_form" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Matricule (Employee ID)</label>
              <input type="text" id="driver_matricule_form" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white" placeholder="e.g., EMP12345">
            </div>
        </div>
        <!-- Add other driver fields here if needed, e.g., phone number, license_number -->
        <div class="flex justify-end gap-3 pt-4">
          <button type="button" onclick="closeAddDriverModal()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">Cancel</button>
          <button type="submit" id="driverSubmitButton" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
            <i data-lucide="plus-circle" class="w-4 h-4"></i> Add Driver
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- View Driver Record Modal -->
<div id="viewDriverModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
    <div class="p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 dark:text-white">Driver Details</h3>
        <button onclick="closeViewDriverModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <div id="viewDriverDetails" class="space-y-3 text-sm">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-3">
            <div><span class="view-detail-label">Driver ID:</span> <span id="view-driver-id" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Full Name:</span> <span id="view-driver-full_name" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Email:</span> <span id="view-driver-email" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">CNI Number:</span> <span id="view-driver-cni_number" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Matricule:</span> <span id="view-driver-matricule" class="view-detail-value"></span></div>
            <div><span class="view-detail-label">Registered At:</span> <span id="view-driver-created_at" class="view-detail-value"></span></div>
            <!-- Add other fields like phone, license -->
        </div>
      </div>
      <div class="flex justify-end pt-6">
          <button type="button" onclick="closeViewDriverModal()" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 rounded-lg">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Generic Confirmation Modal (reused) -->
<div id="genericConfirmModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 id="genericConfirmModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Confirm Action</h3>
        <button onclick="closeGenericConfirmModal()" class="p-1 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
          <i data-lucide="x" class="w-5 h-5 text-gray-500 dark:text-gray-400"></i>
        </button>
      </div>
      <p id="genericConfirmModalMessage" class="text-sm text-gray-600 dark:text-gray-400 mb-6">Are you sure you want to proceed?</p>
      <div class="flex justify-end gap-3 pt-4">
        <button onclick="closeGenericConfirmModal()"
                class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700">
          Cancel
        </button>
        <button id="genericConfirmModalConfirmBtn"
                class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg flex items-center gap-2">
          Confirm
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Information/Status Modal (reused) -->
<div id="infoStatusModal" class="modal fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-50 hidden">
  <div class="modal-content bg-white dark:bg-gray-800 rounded-xl shadow-2xl w-full max-w-md">
    <div class="p-6 text-center">
      <div id="infoStatusModalIconContainer" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
      </div>
      <h3 id="infoStatusModalTitle" class="text-lg leading-6 font-medium text-gray-900 dark:text-white mb-2">Status</h3>
      <div class="mt-2">
        <p id="infoStatusModalMessage" class="text-sm text-gray-500 dark:text-gray-400">Message here.</p>
      </div>
      <div class="mt-5 sm:mt-6">
        <button type="button"
                onclick="closeInfoStatusModal()"
                id="infoStatusModalOkButton"
                class="inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm">
          OK
        </button>
      </div>
    </div>
  </div>
</div>


<script>
  const API_BASE_URL = 'http://localhost:8000';

  // --- Simplified API Request Function ---
  async function apiRequest(endpoint, method = 'GET', body = null) {
    const headers = { 'Content-Type': 'application/json' };
    const config = { method, headers };
    if (body) config.body = JSON.stringify(body);

    try {
      const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
      const responseForJson = response.clone();
      const responseForText = response.clone();

      if (response.status === 204) return true;

      const responseData = await responseForJson.json().catch(async (jsonError) => {
          const text = await responseForText.text();
          console.error(`JSON Parse Error for ${endpoint}. Status: ${response.status}. Response text (first 100 chars): ${text.substring(0,100)}...`, jsonError);
          if (!response.ok) { return Promise.reject({ detail: text || `Server error ${response.status}` }); }
          throw new Error(`Invalid JSON response from server (status ${response.status}). Check console.`);
      });

      if (!response.ok) {
        const errorDetail = responseData.detail || (typeof responseData === 'object' ? JSON.stringify(responseData) : responseData) || 'Unknown server error.';
        console.error(`API Error for ${endpoint}: ${response.status}`, errorDetail);
        openInfoStatusModal(`API Error: ${response.status}`, errorDetail, "error");
        return null;
      }
      return responseData;
    } catch (error) {
      console.error(`Network/Catch Error during API request to ${endpoint}:`, error);
      openInfoStatusModal("Request Error", error.message || "A network error occurred.", "error");
      return null;
    }
  }

  // --- Global Variables for Drivers ---
  let allFetchedDriversFromServer = [];
  const driversPerPage = 5;
  let currentDriverPage = 1;
  let driverToEditId = null;
  // driverToDeleteId is handled by generic confirm modal's currentActionData

  let currentConfirmAction = null;
  let currentActionData = null;
  let infoStatusModalTimeout = null;


  // --- DOMContentLoaded ---
  document.addEventListener('DOMContentLoaded', async () => {
      lucide.createIcons();
      document.getElementById('theme-toggle')?.addEventListener('click', () => document.documentElement.classList.toggle('dark'));

      document.getElementById('addDriverModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeAddDriverModal(); });
      document.getElementById('viewDriverModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeViewDriverModal(); });
      document.getElementById('genericConfirmModal').addEventListener('click', e => { if (e.target === e.currentTarget) closeGenericConfirmModal(); });
      document.getElementById('genericConfirmModalConfirmBtn').addEventListener('click', async () => {
        if (typeof currentConfirmAction === 'function') { await currentConfirmAction(currentActionData); }
        closeGenericConfirmModal();
      });
      document.getElementById('infoStatusModal').addEventListener('click', e => { if (e.target === e.currentTarget || e.target.id === 'infoStatusModalOkButton' || e.target.closest('#infoStatusModalOkButton')) closeInfoStatusModal(); });

      await initializeDriverSection();
  });


  async function initializeDriverSection() {
    console.log("Initializing driver section...");
    await fetchDrivers();
    document.getElementById('driverSearch').addEventListener('input', () => { currentDriverPage = 1; fetchDrivers(); });
    document.getElementById('addDriverForm').addEventListener('submit', handleDriverFormSubmit);
  }


  async function fetchDrivers() {
    const searchTerm = document.getElementById('driverSearch').value;
    const data = await apiRequest(`/driver/?limit=${driversPerPage}&skip=${(currentDriverPage - 1) * driversPerPage}&search=${encodeURIComponent(searchTerm)}`);
    if (data) { allFetchedDriversFromServer = data;} else { allFetchedDriversFromServer = []; }
    renderDriversTable();
  }

  function formatDateTimeForDisplay(dateTimeString) {
    if (!dateTimeString) return 'N/A';
    try { return new Date(dateTimeString).toLocaleDateString(); } // Simpler date format
    catch (e) { return dateTimeString; }
  }

  function renderDriversTable() {
    const recordsToDisplay = [...allFetchedDriversFromServer];

    const driversBody = document.getElementById('driversBody');
    if (recordsToDisplay.length > 0) {
        driversBody.innerHTML = recordsToDisplay.map(d => {
        const fullName = `${d.first_name} ${d.last_name}`;
        return `<tr class="border-b dark:border-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700/50" data-id="${d.id}">
                    <td class="py-3 px-2">${d.id}</td>
                    <td class="px-2">${fullName}</td>
                    <td class="px-2">${d.email}</td>
                    <td class="px-2">${d.matricule}</td>
                    <td class="px-2">${d.cni_number}</td>
                    <td class="px-2">${formatDateTimeForDisplay(d.created_at)}</td>
                    <td class="px-2 text-center whitespace-nowrap">
                    <button onclick="openViewDriverModal(${d.id})" class="text-green-600 dark:text-green-400 p-1" title="View"><i data-lucide="eye" class="w-4 h-4"></i></button>
                    <button onclick="openEditDriverModal(${d.id})" class="text-blue-600 dark:text-blue-400 p-1 ml-1" title="Edit"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                    <button onclick="openConfirmDeleteDriverModal(${d.id})" class="text-red-600 dark:text-red-400 p-1 ml-1" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                    </td></tr>`;
        }).join('');
    } else {
        let message = "No driver records found.";
        if (allFetchedDriversFromServer.length === 0 && !document.getElementById('driverSearch').value) { message = "No drivers in the system yet. Try adding one!";}
        else if (document.getElementById('driverSearch').value) { message = "No drivers match your current search criteria." }
        driversBody.innerHTML = `<tr><td colspan="7" class="text-center py-8 text-gray-500">${message}</td></tr>`;
    }
    lucide.createIcons();
    const displayedRecordCount = recordsToDisplay.length;
    const estimatedStart = displayedRecordCount > 0 ? (currentDriverPage -1) * driversPerPage + 1 : 0;
    const estimatedEnd = (currentDriverPage -1) * driversPerPage + displayedRecordCount;
    document.getElementById('driversCount').textContent = `Showing ${estimatedStart} to ${estimatedEnd} of approx. ${estimatedEnd} records (current view)`;
    renderDriverPagination(allFetchedDriversFromServer.length);
  }

  function renderDriverPagination(currentPageRecordCount) {
    const paginationContainer = document.getElementById('driversPagination');
    paginationContainer.innerHTML = '';
    if (currentDriverPage === 1 && currentPageRecordCount < driversPerPage) {
        if (currentPageRecordCount === 0) {}
        else if (currentPageRecordCount < driversPerPage && currentDriverPage === 1) return;
    }

    const buttonClasses = "px-3 py-1.5 text-sm rounded-md transition-colors duration-150 focus:outline-none focus:ring-2 focus:ring-offset-1 dark:focus:ring-offset-gray-900 focus:ring-blue-500";
    const inactiveClasses = "bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700";
    const disabledClasses = "bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 text-gray-400 dark:text-gray-500 cursor-not-allowed";

    const prevButton = document.createElement('button');
    prevButton.innerHTML = `<i data-lucide="chevron-left" class="w-4 h-4 inline-block mr-1"></i> Prev`;
    prevButton.className = `${buttonClasses} ${currentDriverPage === 1 ? disabledClasses : inactiveClasses}`;
    if (currentDriverPage > 1) { prevButton.onclick = () => { currentDriverPage--; fetchDrivers(); }; }
    else { prevButton.disabled = true; }
    paginationContainer.appendChild(prevButton);

    const pageInfo = document.createElement('span');
    pageInfo.className = "px-3 py-1.5 text-sm text-gray-500 dark:text-gray-400";
    pageInfo.textContent = `Page ${currentDriverPage}`;
    paginationContainer.appendChild(pageInfo);

    const nextButton = document.createElement('button');
    nextButton.innerHTML = `Next <i data-lucide="chevron-right" class="w-4 h-4 inline-block ml-1"></i>`;
    const hasMore = currentPageRecordCount === driversPerPage;
    nextButton.className = `${buttonClasses} ${!hasMore ? disabledClasses : inactiveClasses}`;
    if (hasMore) { nextButton.onclick = () => { currentDriverPage++; fetchDrivers(); }; }
    else { nextButton.disabled = true; }
    paginationContainer.appendChild(nextButton);
    lucide.createIcons();
  }

  async function openAddDriverModal() {
    driverToEditId = null;
    document.getElementById('addDriverForm').reset();
    document.getElementById('driverModalTitle').textContent = "Add New Driver";
    document.getElementById('driverSubmitButton').innerHTML = `<i data-lucide="plus-circle" class="w-4 h-4"></i> Add Driver`;
    lucide.createIcons();
    document.getElementById('addDriverModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  async function openEditDriverModal(id) {
    const recordToEdit = await apiRequest(`/driver/${id}`);
    if (!recordToEdit) { openInfoStatusModal("Error","Could not fetch driver details for editing.", "error"); return; }

    driverToEditId = id;
    document.getElementById('addDriverForm').reset();

    document.getElementById('driverModalTitle').textContent = "Edit Driver Record";
    document.getElementById('driverSubmitButton').innerHTML = `<i data-lucide="save" class="w-4 h-4"></i> Save Changes`;

    document.getElementById('driverId_form').value = recordToEdit.id;
    document.getElementById('driver_first_name_form').value = recordToEdit.first_name;
    document.getElementById('driver_last_name_form').value = recordToEdit.last_name;
    document.getElementById('driver_email_form').value = recordToEdit.email;
    document.getElementById('driver_cni_number_form').value = recordToEdit.cni_number;
    document.getElementById('driver_matricule_form').value = recordToEdit.matricule;

    lucide.createIcons();
    document.getElementById('addDriverModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function closeAddDriverModal() {
    document.getElementById('addDriverModal').classList.add('hidden');
    document.body.style.overflow = '';
    driverToEditId = null;
    document.getElementById('addDriverForm').reset();
  }

  async function openViewDriverModal(id) {
    const record = await apiRequest(`/driver/${id}`);
    if (!record) { openInfoStatusModal("Error", "Could not fetch driver details.", "error"); return; }

    document.getElementById('view-driver-id').textContent = record.id;
    document.getElementById('view-driver-full_name').textContent = `${record.first_name} ${record.last_name}`;
    document.getElementById('view-driver-email').textContent = record.email;
    document.getElementById('view-driver-cni_number').textContent = record.cni_number;
    document.getElementById('view-driver-matricule').textContent = record.matricule;
    document.getElementById('view-driver-created_at').textContent = formatDateTimeForDisplay(record.created_at);

    document.getElementById('viewDriverModal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    lucide.createIcons();
  }
  function closeViewDriverModal() { document.getElementById('viewDriverModal').classList.add('hidden'); document.body.style.overflow = ''; }


  // --- Generic Confirmation & Info/Status Modals (Copied) ---
  function openGenericConfirmModal(title, message, confirmButtonText, confirmButtonIcon, onConfirmCallback, actionData = null) {
    document.getElementById('genericConfirmModalTitle').textContent = title;
    document.getElementById('genericConfirmModalMessage').textContent = message;
    const confirmBtn = document.getElementById('genericConfirmModalConfirmBtn');
    confirmBtn.innerHTML = `<i data-lucide="${confirmButtonIcon || 'check-circle'}" class="w-4 h-4"></i> ${confirmButtonText || 'Confirm'}`;
    if(confirmButtonIcon === 'trash-2'){ confirmBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600'); confirmBtn.classList.add('bg-red-500', 'hover:bg-red-600');}
    else { confirmBtn.classList.remove('bg-red-500', 'hover:bg-red-600'); confirmBtn.classList.add('bg-blue-500', 'hover:bg-blue-600');}
    lucide.createIcons(); currentConfirmAction = onConfirmCallback; currentActionData = actionData;
    document.getElementById('genericConfirmModal').classList.remove('hidden'); document.body.style.overflow = 'hidden';
  }
  function closeGenericConfirmModal() {
    document.getElementById('genericConfirmModal').classList.add('hidden'); document.body.style.overflow = '';
    currentConfirmAction = null; currentActionData = null;
  }
  function openInfoStatusModal(title, message, type = 'success', autoCloseDelay = 3000) {
    const modal = document.getElementById('infoStatusModal');
    const titleEl = document.getElementById('infoStatusModalTitle');
    const messageEl = document.getElementById('infoStatusModalMessage');
    const iconContainer = document.getElementById('infoStatusModalIconContainer');
    const okButton = document.getElementById('infoStatusModalOkButton');
    titleEl.textContent = title; messageEl.textContent = message;
    if (infoStatusModalTimeout) clearTimeout(infoStatusModalTimeout);
    iconContainer.innerHTML = '';
    if (type === 'success') { iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4'; iconContainer.innerHTML = `<i data-lucide="check" class="h-6 w-6 text-green-600"></i>`; okButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-green-600 text-base font-medium text-white hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 sm:text-sm';}
    else if (type === 'error') { iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4'; iconContainer.innerHTML = `<i data-lucide="x-circle" class="h-6 w-6 text-red-600"></i>`; okButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:text-sm';}
    else { iconContainer.className = 'mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4'; iconContainer.innerHTML = `<i data-lucide="info" class="h-6 w-6 text-blue-600"></i>`; okButton.className = 'inline-flex justify-center w-full rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:text-sm';}
    lucide.createIcons();
    modal.classList.remove('hidden'); document.body.style.overflow = 'hidden';
    if (autoCloseDelay > 0) { infoStatusModalTimeout = setTimeout(() => { closeInfoStatusModal(); }, autoCloseDelay); }
  }
  function closeInfoStatusModal() {
    if (infoStatusModalTimeout) { clearTimeout(infoStatusModalTimeout); infoStatusModalTimeout = null; }
    document.getElementById('infoStatusModal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  async function handleDriverFormSubmit(event) {
    event.preventDefault();

    const driverData = {
      first_name: document.getElementById('driver_first_name_form').value.trim(),
      last_name: document.getElementById('driver_last_name_form').value.trim(),
      email: document.getElementById('driver_email_form').value.trim(),
      cni_number: document.getElementById('driver_cni_number_form').value.trim(),
      matricule: document.getElementById('driver_matricule_form').value.trim(),
    };

     if (!driverData.first_name || !driverData.last_name || !driverData.email || !driverData.cni_number || !driverData.matricule) {
      openInfoStatusModal("Validation Error", "Please fill all required driver fields.", "error"); return;
    }
    // Basic email validation
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(driverData.email)) {
        openInfoStatusModal("Validation Error", "Please enter a valid email address.", "error"); return;
    }

    const actionType = driverToEditId ? "update" : "add";
    const confirmTitle = driverToEditId ? "Confirm Update" : "Confirm Add Driver";
    const confirmMessage = `Are you sure you want to ${actionType} this driver${driverToEditId ? "'s details" : ""}?`;
    const confirmBtnText = driverToEditId ? "Update" : "Add Driver";
    const confirmBtnIcon = driverToEditId ? "save" : "plus-circle";

    openGenericConfirmModal(
        confirmTitle, confirmMessage, confirmBtnText, confirmBtnIcon,
        async (dataForAction) => {
            let result;
            if (driverToEditId) {
                 // For PUT, your driver.py expects all fields (DriverCreate schema)
                result = await apiRequest(`/driver/${driverToEditId}`, 'PUT', dataForAction);
            } else {
                result = await apiRequest('/driver/', 'POST', dataForAction);
            }

            if (result) {
              openInfoStatusModal("Success", `Driver record ${driverToEditId ? 'updated' : 'added'} successfully!`, "success");
              closeAddDriverModal();
              currentDriverPage = driverToEditId ? currentDriverPage : 1;
              await fetchDrivers();
            }
        },
        driverData
    );
  }

  function openConfirmDeleteDriverModal(id) {
      openGenericConfirmModal(
        "Confirm Deletion",
        "Are you sure you want to permanently delete this driver record? This action cannot be undone and might affect related trip records.",
        "Delete", "trash-2",
        async (driverIdToDelete) => { // driverIdToDelete comes from currentActionData
            if (!driverIdToDelete) return;
            const result = await apiRequest(`/driver/${driverIdToDelete}`, 'DELETE');
            if (result) { // apiRequest returns true for successful 204
                openInfoStatusModal("Success", "Driver record deleted successfully!", "success");
                if(allFetchedDriversFromServer.length === 1 && currentDriverPage > 1) {
                    currentDriverPage--;
                }
                await fetchDrivers();
            }
        },
        id // Pass the id as actionData
      );
  }


  function getDriverExportData() {
    // Search is handled by API, so allFetchedDriversFromServer should be pre-filtered
    // If you implement more client-side filters, apply them here.
    return [...allFetchedDriversFromServer];
  }

  function exportDriversExcel() {
    const recordsToExport = getDriverExportData();
    if (recordsToExport.length === 0) { openInfoStatusModal("Export Info", "No data to export.", "info"); return; }

    const wsData = recordsToExport.map(d => ({
        'ID': d.id,
        'First Name': d.first_name,
        'Last Name': d.last_name,
        'Email': d.email,
        'CNI Number': d.cni_number,
        'Matricule': d.matricule,
        'Registered At': formatDateTimeForDisplay(d.created_at)
    }));
    const ws = XLSX.utils.json_to_sheet(wsData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Drivers");
    XLSX.writeFile(wb, "drivers_export.xlsx");
  }

  function exportDriversPDF() {
    const {jsPDF} = window.jspdf;
    const doc = new jsPDF(); // Default portrait
    doc.setFontSize(18); doc.text('Driver Records', 14, 15);

    const recordsToExport = getDriverExportData();
    if (recordsToExport.length === 0) { openInfoStatusModal("Export Info", "No data to export.", "info"); return; }

    const headers = [['ID', 'Full Name', 'Email', 'Matricule', 'CNI']];
    const data = recordsToExport.map(d => [
        d.id,
        `${d.first_name} ${d.last_name}`,
        d.email,
        d.matricule,
        d.cni_number
    ]);

    doc.autoTable({
        head: headers, body: data, startY: 25, theme:'grid',
        headStyles:{fillColor:[59,130,246], textColor:255},
        // Adjust columnStyles if needed for driver data
        // columnStyles: { 0:{cellWidth: 10}, 1:{cellWidth: 50}, 2:{cellWidth: 60}}
    });
    doc.save('drivers_export.pdf');
  }
</script>
</body>
</html>